<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#1A6B8A">
<title>ReynoldsHub</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,400;0,700;0,900;1,400&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ ISLAND TOKENS ‚îÄ‚îÄ */
:root{
  --ocean:#1A6B8A;--ocean-l:#2E9CBF;--ocean-ll:#D6F0F8;
  --sand:#FDF8EF;--sand-d:#F0E8D6;--sand-m:#E6D9C0;
  --coral:#E8634A;--coral-l:#FCEAE6;
  --palm:#2E7D52;--palm-l:#4CAF78;--palm-ll:#D4EDDE;
  --sun:#F2B234;--sun-l:#FEF3D6;
  --ink:#1C2A35;--ink-m:#4A6070;--ink-l:#8AA5B5;
  --white:#FFFFFF;
  --r:16px;--rs:10px;
  --shadow:0 2px 16px rgba(26,107,138,.10);
  --shadow-lg:0 8px 40px rgba(26,107,138,.18);
}
/* re-map semantic vars so existing code still works */
:root{
  --forest:var(--ocean);--forest-l:var(--ocean-l);--forest-ll:var(--ocean-ll);
  --amber:var(--sun);--amber-l:var(--sun-l);
  --rose:var(--coral);--rose-l:var(--coral-l);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--sand);color:var(--ink);min-height:100vh;overflow-x:hidden;}
h1,h2,h3,.serif{font-family:'Fraunces',serif;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;min-height:100vh;}
.screen.on{display:flex;}

/* ‚îÄ‚îÄ LOGIN / SIGNUP ‚îÄ‚îÄ */
#s-login{align-items:center;justify-content:center;flex-direction:column;padding:2rem;min-height:100vh;width:100%;background:linear-gradient(160deg,#0D4F6E 0%,#1A6B8A 40%,#2E9CBF 70%,#87CEEB 100%);overflow-y:auto;}
#s-login::before{content:'üå¥';position:absolute;bottom:0;left:2%;font-size:8rem;line-height:1;opacity:.45;transform:rotate(-8deg);pointer-events:none;}
#s-login::after{content:'üå¥';position:absolute;bottom:0;right:3%;font-size:6.5rem;line-height:1;opacity:.4;transform:rotate(10deg) scaleX(-1);pointer-events:none;}
/* wave strip at bottom of login */
#s-login .wave{position:absolute;bottom:0;left:0;right:0;height:90px;background:linear-gradient(transparent,rgba(135,206,235,.35));pointer-events:none;}
.auth-card{background:rgba(255,255,255,.96);backdrop-filter:blur(8px);border-radius:24px;padding:2.5rem 2rem;max-width:400px;width:100%;position:relative;z-index:1;box-shadow:var(--shadow-lg);}
.auth-logo{font-family:'Fraunces',serif;font-size:2rem;font-weight:900;color:var(--ocean);margin-bottom:.25rem;}
.auth-logo span{color:var(--coral);}
.auth-sub{color:var(--ink-m);font-size:.9rem;margin-bottom:2rem;}
.fld{margin-bottom:1rem;}
.fld label{display:block;font-size:.78rem;font-weight:700;color:var(--ink-m);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.375rem;}
.fld input,.fld select,.fld textarea{width:100%;padding:.75rem 1rem;border:2px solid var(--sand-d);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:.95rem;color:var(--ink);outline:none;transition:border-color .2s;background:var(--sand);}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--ocean);background:var(--white);}
.btn{width:100%;padding:.85rem;border:none;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-forest{background:var(--ocean);color:var(--white);}
.btn-forest:hover{background:var(--ocean-l);}
.btn-outline{background:transparent;border:2px solid var(--sand-d);color:var(--ink-m);margin-top:.75rem;}
.btn-outline:hover{border-color:var(--ocean);color:var(--ocean);}
.auth-link{text-align:center;margin-top:1.25rem;font-size:.875rem;color:var(--ink-m);}
.auth-link a{color:var(--ocean);font-weight:700;cursor:pointer;text-decoration:none;}
.auth-err{background:var(--coral-l);color:var(--coral);border-radius:var(--rs);padding:.75rem 1rem;font-size:.875rem;font-weight:600;margin-bottom:1rem;display:none;}
.auth-ok{background:var(--palm-ll);color:var(--palm);border-radius:var(--rs);padding:.75rem 1rem;font-size:.875rem;font-weight:600;margin-bottom:1rem;display:none;}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#s-app{flex-direction:column;background:var(--sand);}
.topbar{background:linear-gradient(135deg,#0D4F6E,#1A6B8A);padding:.875rem 1.25rem;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(13,79,110,.25);position:sticky;top:0;z-index:100;}
.topbar-title{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:900;color:#fff;}
.topbar-title span{color:var(--sun);}
.topbar-right{display:flex;align-items:center;gap:.75rem;}
.user-pill{display:flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.18);border-radius:30px;padding:.375rem .75rem .375rem .375rem;cursor:pointer;transition:background .2s;position:relative;}
.user-pill:hover{background:rgba(255,255,255,.28);}
.user-av{width:30px;height:30px;border-radius:50%;background:var(--sun);color:var(--ink);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;}
.user-av img{width:30px;height:30px;border-radius:50%;object-fit:cover;}
.user-name{font-size:.85rem;font-weight:600;color:#fff;}
.dropdown{position:absolute;top:calc(100% + 8px);right:0;background:var(--white);border-radius:var(--r);box-shadow:var(--shadow-lg);padding:.5rem;min-width:160px;display:none;z-index:200;}
.dropdown.on{display:block;}
.dd-item{padding:.625rem .875rem;border-radius:8px;font-size:.875rem;font-weight:600;cursor:pointer;color:var(--ink);white-space:nowrap;}
.dd-item:hover{background:var(--sand);}
.dd-item.danger{color:var(--coral);}
.dd-sep{height:1px;background:var(--sand-d);margin:.375rem 0;}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.bottomnav{position:fixed;bottom:0;left:0;right:0;background:var(--white);display:flex;box-shadow:0 -1px 0 var(--sand-d);z-index:100;padding-bottom:env(safe-area-inset-bottom);overflow-x:auto;overflow-y:hidden;scrollbar-width:none;}
.bottomnav::-webkit-scrollbar{display:none;}
.nb{flex:0 0 auto;min-width:60px;padding:.625rem .35rem .5rem;border:none;background:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:.2rem;font-family:'DM Sans',sans-serif;font-size:.58rem;font-weight:600;color:var(--ink-l);transition:color .15s;}
.nb .ni{font-size:1.25rem;transition:transform .15s;}
.nb.on{color:var(--ocean);}
.nb.on .ni{transform:scale(1.1);}
.nb-badge{background:var(--coral);color:#fff;font-size:.55rem;font-weight:800;padding:1px 5px;border-radius:10px;position:absolute;top:-2px;right:-4px;}
.nb-wrap{position:relative;}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{flex:1;padding:1.25rem;padding-bottom:5.5rem;max-width:640px;margin:0 auto;width:100%;}
.sec{display:none;}
.sec.on{display:block;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--white);border-radius:var(--r);padding:1.25rem;margin-bottom:1rem;box-shadow:var(--shadow);}
.card-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:.875rem;gap:.5rem;flex-wrap:wrap;}
.card-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--ink);}
.btn-sm{padding:.45rem .875rem;border:none;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-weight:700;font-size:.8rem;cursor:pointer;transition:all .15s;}
.btn-sm-forest{background:var(--ocean);color:var(--white);}
.btn-sm-forest:hover{background:var(--ocean-l);}
.btn-sm-amber{background:var(--sun);color:var(--white);}
.btn-sm-ghost{background:var(--sand);color:var(--ink-m);border:2px solid var(--sand-d);}
.btn-sm-ghost:hover{border-color:var(--ocean);color:var(--ocean);}
.empty{text-align:center;padding:2rem 1rem;color:var(--ink-l);}
.empty-ico{font-size:2rem;display:block;margin-bottom:.5rem;}

/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
.cal-m{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;}
.cnav{background:var(--sand-d);border:none;border-radius:50%;width:34px;height:34px;cursor:pointer;color:var(--ocean);font-size:1.1rem;font-weight:700;transition:all .15s;}
.cnav:hover{background:var(--ocean);color:var(--white);}
.cgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cdh{text-align:center;font-size:.68rem;font-weight:700;color:var(--ink-l);padding:.3rem;text-transform:uppercase;}
.cd{aspect-ratio:1;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:600;cursor:pointer;position:relative;transition:all .15s;}
.cd:hover{background:var(--ocean-ll);}
.cd.today{background:var(--ocean);color:var(--white);}
.cd.sel{background:var(--coral);color:var(--white);}
.cal-dots{position:absolute;bottom:2px;left:50%;transform:translateX(-50%);display:flex;gap:2px;align-items:center;max-width:90%;}
.cal-dot-pip{width:5px;height:5px;border-radius:50%;flex-shrink:0;display:block;}
.cd.today .cal-dot-pip,.cd.sel .cal-dot-pip{opacity:.85;}
.cd.dim{opacity:.3;}
.ev-item{display:flex;align-items:flex-start;gap:.75rem;padding:.75rem;background:var(--sand);border-radius:var(--rs);margin-bottom:.5rem;}
.ev-date-sep{font-size:.72rem;font-weight:800;color:var(--ocean);text-transform:uppercase;letter-spacing:.07em;padding:.5rem 0 .25rem;margin-top:.125rem;}
.ev-dot{width:11px;height:11px;border-radius:50%;margin-top:3px;flex-shrink:0;}
.ev-info{flex:1;}
.ev-name{font-weight:700;font-size:.9rem;}
.ev-meta{font-size:.75rem;color:var(--ink-m);margin-top:2px;}
.xbtn{background:none;border:none;cursor:pointer;opacity:.3;font-size:.95rem;padding:0 3px;transition:opacity .15s;}
.xbtn:hover{opacity:1;}
.dot-or{background:#E9854C;}.dot-gr{background:var(--ocean-l);}.dot-bl{background:#4C89C8;}.dot-pk{background:var(--coral);}.dot-ye{background:var(--sun);}

/* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
.t-item{display:flex;align-items:center;gap:.75rem;padding:.875rem;background:var(--sand);border-radius:var(--rs);margin-bottom:.5rem;}
.t-item.dn{opacity:.45;}
.t-item.dn .t-lbl{text-decoration:line-through;}
.tchk{width:24px;height:24px;border-radius:50%;border:2.5px solid var(--sand-d);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0;transition:all .2s;}
.tchk.on{background:var(--ocean);border-color:var(--ocean);color:var(--white);}
.t-lbl{flex:1;font-weight:600;font-size:.9rem;}
.t-who{font-size:.7rem;background:var(--ocean-ll);color:var(--ocean);font-weight:700;padding:2px 8px;border-radius:20px;}
.pri{font-size:.65rem;padding:2px 7px;border-radius:20px;font-weight:700;}
.pri-h{background:var(--coral-l);color:var(--coral);}
.pri-m{background:#FEF3C7;color:#B45309;}
.pri-l{background:var(--palm-ll);color:var(--palm);}

/* ‚îÄ‚îÄ MEALS ‚îÄ‚îÄ */
.m-card{background:var(--white);border-radius:var(--r);margin-bottom:.75rem;overflow:hidden;box-shadow:var(--shadow);}
.m-hdr{background:linear-gradient(135deg,#0D4F6E,#1A6B8A);padding:.75rem 1rem;}
.m-day{font-family:'Fraunces',serif;font-weight:700;font-size:1rem;color:var(--white);}
.m-slot{display:flex;align-items:center;padding:.625rem 1rem;border-bottom:1px solid var(--sand);gap:.75rem;}
.m-slot:last-child{border-bottom:none;}
.m-slot-lbl{font-size:.72rem;font-weight:700;color:var(--ink-l);text-transform:uppercase;width:68px;flex-shrink:0;}
.m-slot-val{flex:1;font-size:.875rem;font-weight:600;cursor:pointer;padding:3px 8px;border-radius:8px;transition:background .15s;}
.m-slot-val:hover{background:var(--sand);}
.m-slot-val.emp{color:var(--ink-l);}

/* ‚îÄ‚îÄ SHOPPING ‚îÄ‚îÄ */
.s-cat{margin-bottom:1.25rem;}
.s-cat-t{font-weight:700;font-size:.75rem;text-transform:uppercase;color:var(--ink-l);letter-spacing:.06em;margin-bottom:.5rem;}
.s-item{display:flex;align-items:center;gap:.75rem;padding:.6rem .75rem;border-radius:var(--rs);transition:background .15s;}
.s-item:hover{background:var(--sand);}
.schk{width:22px;height:22px;border:2.5px solid var(--sand-d);border-radius:6px;background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;flex-shrink:0;transition:all .2s;}
.schk.on{background:var(--ocean);border-color:var(--ocean);color:var(--white);}
.s-lbl{flex:1;font-weight:600;font-size:.875rem;}
.s-item.dn .s-lbl{text-decoration:line-through;opacity:.45;}
.s-qty{font-size:.78rem;color:var(--ink-l);font-weight:600;}
.ai-badge{font-size:.58rem;background:#EDE9FE;color:#6D28D9;font-weight:800;padding:2px 6px;border-radius:20px;margin-left:.25rem;}
.pbar-wrap{background:var(--sand-d);border-radius:20px;height:7px;margin-bottom:.875rem;overflow:hidden;}
.pbar-fill{background:linear-gradient(90deg,var(--ocean),var(--ocean-l));height:100%;border-radius:20px;transition:width .4s;}
.pbar-lbl{font-size:.78rem;color:var(--ink-l);text-align:right;margin-bottom:.4rem;font-weight:600;}

/* ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ */
.note-card{background:var(--white);border-radius:var(--r);padding:1.25rem;margin-bottom:.875rem;box-shadow:var(--shadow);border-left:4px solid var(--ocean);}
.note-card.pinned{border-left-color:var(--sun);background:var(--sun-l);}
.note-header{display:flex;align-items:flex-start;justify-content:space-between;gap:.5rem;margin-bottom:.5rem;}
.note-title{font-family:'Fraunces',serif;font-weight:700;font-size:1rem;}
.note-body{font-size:.875rem;color:var(--ink-m);line-height:1.6;}
.note-footer{display:flex;align-items:center;gap:.5rem;margin-top:.75rem;font-size:.75rem;color:var(--ink-l);}
.note-author{font-weight:700;color:var(--ocean);}
.pin-badge{font-size:.65rem;background:var(--sun);color:var(--white);padding:2px 7px;border-radius:20px;font-weight:700;}

/* ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ */
.photo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-bottom:1rem;}
@media(min-width:480px){.photo-grid{grid-template-columns:repeat(3,1fr);}}
.photo-card{border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);cursor:pointer;position:relative;aspect-ratio:1;}
.photo-card img{width:100%;height:100%;object-fit:cover;transition:transform .3s;}
.photo-card:hover img{transform:scale(1.05);}
.photo-caption{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(28,43,43,.8));padding:.75rem .625rem .5rem;color:var(--white);font-size:.75rem;font-weight:600;}
.photo-delete{position:absolute;top:.5rem;right:.5rem;background:rgba(28,43,43,.5);border:none;color:var(--white);border-radius:50%;width:26px;height:26px;cursor:pointer;display:none;align-items:center;justify-content:center;font-size:.75rem;}
.photo-card:hover .photo-delete{display:flex;}
.upload-zone{border:2px dashed var(--sand-d);border-radius:var(--r);padding:2rem;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:1rem;}
.upload-zone:hover{border-color:var(--ocean);background:var(--ocean-ll);}
.upload-zone-ico{font-size:2rem;display:block;margin-bottom:.5rem;}
.upload-zone-txt{font-size:.875rem;color:var(--ink-m);font-weight:600;}

/* ‚îÄ‚îÄ PHOTO LIGHTBOX ‚îÄ‚îÄ */
.lightbox{position:fixed;inset:0;background:rgba(28,43,43,.92);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;padding:1rem;}
.lightbox.on{display:flex;}
.lightbox img{max-width:100%;max-height:75vh;border-radius:var(--r);object-fit:contain;}
.lightbox-caption{color:var(--white);font-size:.9rem;margin-top:.75rem;font-weight:600;}
.lightbox-close{position:absolute;top:1rem;right:1rem;background:rgba(255,255,255,.15);border:none;color:var(--white);border-radius:50%;width:40px;height:40px;font-size:1.25rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* ‚îÄ‚îÄ AI CHEF ‚îÄ‚îÄ */
.helper-hero{background:linear-gradient(135deg,#0D4F6E,#1A6B8A,#2E9CBF);border-radius:var(--r);padding:1.25rem;margin-bottom:1rem;color:var(--white);display:flex;align-items:center;gap:1rem;}
.helper-hero-ico{font-size:2.5rem;}
.helper-hero h2{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;}
.helper-hero p{font-size:.82rem;opacity:.85;margin-top:2px;}
.qchips{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.qchip{background:var(--white);border:2px solid var(--sand-d);border-radius:20px;padding:.375rem .875rem;font-size:.78rem;font-weight:700;color:var(--ink-m);cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;}
.qchip:hover{border-color:var(--ocean);color:var(--ocean);}
.chatbox{background:var(--white);border-radius:var(--r);box-shadow:var(--shadow);display:flex;flex-direction:column;height:380px;overflow:hidden;margin-bottom:1rem;}
.msgs{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem;}
.cmsg{display:flex;gap:.625rem;align-items:flex-end;animation:msgpop .25s ease;}
@keyframes msgpop{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.cmsg.u{flex-direction:row-reverse;}
.cbubble{max-width:82%;padding:.75rem 1rem;border-radius:18px;font-size:.85rem;line-height:1.55;font-weight:500;}
.cmsg.ai .cbubble{background:var(--ocean-ll);color:var(--ink);border-bottom-left-radius:4px;}
.cmsg.u .cbubble{background:var(--ocean);color:var(--white);border-bottom-right-radius:4px;}
.cmav{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0;}
.cmsg.ai .cmav{background:linear-gradient(135deg,#0D4F6E,var(--ocean));}
.cmsg.u .cmav{background:var(--ocean-l);}
.typing-dots{display:flex;gap:4px;align-items:center;padding:.75rem 1rem;background:var(--ocean-ll);border-radius:18px;border-bottom-left-radius:4px;width:fit-content;}
.typing-dots span{width:7px;height:7px;background:var(--ocean);border-radius:50%;animation:td 1.2s infinite;}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
.chat-input-row{display:flex;gap:.5rem;padding:.875rem;border-top:1px solid var(--sand);}
.cinput{flex:1;border:2px solid var(--sand-d);border-radius:24px;padding:.6rem 1rem;font-family:'DM Sans',sans-serif;font-size:.875rem;font-weight:500;outline:none;transition:border-color .2s;background:var(--sand);}
.cinput:focus{border-color:var(--ocean);background:var(--white);}
.csend{background:var(--ocean);color:var(--white);border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;font-size:1rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.csend:hover{background:var(--ocean-l);transform:scale(1.05);}
.csend:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.ai-plan-card{background:var(--white);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-bottom:1rem;display:none;}
.ai-plan-card.on{display:block;animation:msgpop .3s ease;}
.ai-plan-hdr{background:linear-gradient(135deg,#0D4F6E,var(--ocean));padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;}
.ai-plan-hdr-t{color:var(--white);font-family:'Fraunces',serif;font-weight:700;font-size:1rem;}
.apply-btn{background:var(--sun);color:var(--white);border:none;border-radius:var(--rs);padding:.45rem 1rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.8rem;cursor:pointer;transition:opacity .15s;}
.apply-btn:hover{opacity:.9;}
.ai-plan-body{padding:1rem 1.25rem;}
.ai-mr{display:flex;gap:.5rem;align-items:baseline;margin-bottom:.375rem;}
.ai-md{font-weight:700;font-size:.72rem;color:var(--ink-l);text-transform:uppercase;width:68px;flex-shrink:0;}
.ai-mv{font-size:.85rem;font-weight:600;}
.ai-shop-preview{margin-top:.875rem;padding-top:.875rem;border-top:1px solid var(--sand);}
.ai-shop-t{font-size:.72rem;font-weight:700;color:var(--ink-l);text-transform:uppercase;margin-bottom:.5rem;}
.ai-tags{display:flex;flex-wrap:wrap;gap:.375rem;}
.ai-tag{background:var(--ocean-ll);color:var(--ocean);font-size:.73rem;font-weight:700;padding:3px 9px;border-radius:20px;}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
.admin-hero{background:linear-gradient(135deg,#0D3040,#1A4A5E);border-radius:var(--r);padding:1.25rem;color:var(--white);margin-bottom:1rem;display:flex;align-items:center;gap:1rem;}
.admin-hero-ico{font-size:2.5rem;}
.admin-hero h2{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;}
.admin-hero p{font-size:.82rem;opacity:.75;margin-top:2px;}
.user-row{display:flex;align-items:center;gap:.75rem;padding:.875rem;background:var(--sand);border-radius:var(--rs);margin-bottom:.5rem;}
.user-row-av{width:36px;height:36px;border-radius:50%;background:var(--ocean);color:var(--white);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;flex-shrink:0;}
.user-row-info{flex:1;}
.user-row-name{font-weight:700;font-size:.9rem;}
.user-row-meta{font-size:.75rem;color:var(--ink-l);margin-top:1px;}
.role-badge{font-size:.65rem;padding:2px 8px;border-radius:20px;font-weight:700;}
.role-admin{background:#FEF3C7;color:#92400E;}
.role-member{background:var(--ocean-ll);color:var(--ocean);}
.pending-card{background:var(--sun-l);border:2px solid var(--sun);border-radius:var(--r);padding:1.25rem;margin-bottom:.875rem;}
.pending-name{font-weight:700;font-size:1rem;margin-bottom:.25rem;}
.pending-meta{font-size:.82rem;color:var(--ink-m);margin-bottom:.875rem;}
.pending-actions{display:flex;gap:.5rem;}
.btn-approve{background:var(--ocean);color:var(--white);border:none;border-radius:var(--rs);padding:.5rem 1rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer;}
.btn-reject{background:var(--coral);color:var(--white);border:none;border-radius:var(--rs);padding:.5rem 1rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer;}
.admin-stat{background:var(--white);border-radius:var(--r);padding:1rem;text-align:center;box-shadow:var(--shadow);}
.admin-stat-n{font-family:'Fraunces',serif;font-size:2rem;font-weight:900;color:var(--ocean);}
.admin-stat-l{font-size:.78rem;color:var(--ink-l);font-weight:600;text-transform:uppercase;margin-top:.25rem;}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.ov{position:fixed;inset:0;background:rgba(28,43,43,.55);z-index:300;display:none;align-items:flex-end;justify-content:center;}
.ov.on{display:flex;}
.modal{background:var(--white);border-radius:24px 24px 0 0;padding:1.5rem 1.5rem 2.5rem;width:100%;max-width:600px;transform:translateY(100%);transition:transform .3s cubic-bezier(.34,1.56,.64,1);}
.ov.on .modal{transform:translateY(0);}
.mhandle{width:36px;height:4px;background:var(--sand-d);border-radius:2px;margin:0 auto 1.25rem;}
.mtitle{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;margin-bottom:1.25rem;}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
.cpick{display:flex;gap:.5rem;}
.copt{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s;}
.copt:hover{transform:scale(1.15);}
.copt.on{border-color:var(--ink);transform:scale(1.1);}
.chips{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.375rem;}
.chip{padding:.375rem .875rem;border-radius:20px;background:var(--sand);font-size:.82rem;font-weight:700;cursor:pointer;border:2px solid transparent;color:var(--ink-m);font-family:'DM Sans',sans-serif;transition:all .15s;}
.chip.on{background:var(--ocean-ll);border-color:var(--ocean);color:var(--ocean);}
.sbtn{width:100%;padding:.85rem;border:none;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;background:var(--ocean);color:var(--white);margin-top:.75rem;}
.sbtn:hover{background:var(--ocean-l);}

/* ‚îÄ‚îÄ MEMBER COLORS ‚îÄ‚îÄ */
.member-swatch{width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.75rem;flex-shrink:0;}
.member-row{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--sand);border-radius:var(--rs);margin-bottom:.5rem;}
.member-row-info{flex:1;}
.member-row-name{font-weight:700;font-size:.9rem;}
.t-who-colored{font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:20px;color:#fff;}
.ev-who-tag{font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:20px;color:#fff;display:inline-block;}
.member-chip-pick{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.375rem;}
.mcp{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.8rem;}
.mcp:hover{transform:scale(1.15);}
.mcp.on{border-color:var(--ink);transform:scale(1.1);}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
.section-lbl{font-size:.72rem;font-weight:700;color:var(--ink-l);text-transform:uppercase;letter-spacing:.08em;padding:.75rem 0 .25rem;margin-top:.25rem;}

/* ‚îÄ‚îÄ CONTACTS ‚îÄ‚îÄ */
.ct-card{background:var(--white);border-radius:var(--r);padding:1rem 1.25rem;margin-bottom:.625rem;box-shadow:var(--shadow);display:flex;align-items:center;gap:.875rem;}
.ct-av{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.ct-info{flex:1;min-width:0;}
.ct-name{font-weight:700;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ct-role{font-size:.75rem;color:var(--ink-m);margin-top:1px;}
.ct-actions{display:flex;gap:.375rem;align-items:center;flex-shrink:0;}
.ct-call{background:var(--palm-ll);color:var(--palm);border:none;border-radius:var(--rs);padding:.4rem .75rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.75rem;cursor:pointer;text-decoration:none;white-space:nowrap;}
.ct-group-hdr{font-size:.72rem;font-weight:800;color:var(--ink-l);text-transform:uppercase;letter-spacing:.07em;padding:.625rem 0 .375rem;margin-top:.25rem;}

/* ‚îÄ‚îÄ CALENDAR HERO ‚îÄ‚îÄ */

.wo-card{background:var(--white);border-radius:var(--r);padding:1.1rem 1.25rem;margin-bottom:.75rem;box-shadow:var(--shadow);display:flex;align-items:flex-start;gap:.875rem;}
.wo-icon{font-size:1.5rem;flex-shrink:0;margin-top:2px;}
.wo-info{flex:1;}
.wo-name{font-weight:700;font-size:.95rem;margin-bottom:2px;}
.wo-meta{font-size:.75rem;color:var(--ink-m);display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-top:.2rem;}
.wo-tag{font-size:.65rem;background:var(--ocean-ll);color:var(--ocean);font-weight:700;padding:2px 8px;border-radius:20px;}
.wo-type-badge{font-size:.65rem;padding:2px 8px;border-radius:20px;font-weight:700;}
.wo-type-strength{background:#FEF3C7;color:#92400E;}
.wo-type-cardio{background:var(--coral-l);color:var(--coral);}
.wo-type-flexibility{background:var(--palm-ll);color:var(--palm);}
.wo-type-sports{background:var(--ocean-ll);color:var(--ocean);}
.wo-type-custom{background:var(--sand-d);color:var(--ink-m);}
.wo-notes{font-size:.78rem;color:var(--ink-l);margin-top:.375rem;line-height:1.5;}
.member-tab{padding:.45rem .875rem;border-radius:20px;border:2px solid var(--sand-d);background:var(--white);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:700;color:var(--ink-m);cursor:pointer;transition:all .15s;}
.member-tab.on{color:#fff;border-color:transparent;}

/* ‚îÄ‚îÄ BUDGET ‚îÄ‚îÄ */
.btx-item{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--sand);border-radius:var(--rs);margin-bottom:.5rem;}
.btx-icon{font-size:1.1rem;flex-shrink:0;}
.btx-info{flex:1;}
.btx-desc{font-weight:700;font-size:.875rem;}
.btx-cat{font-size:.72rem;color:var(--ink-l);margin-top:1px;}
.btx-amt{font-family:'Fraunces',serif;font-weight:900;font-size:1rem;}
.btx-amt.income{color:var(--palm);}
.btx-amt.expense{color:var(--coral);}
.budget-cat-row{display:flex;align-items:center;gap:.625rem;margin-bottom:.625rem;}
.budget-cat-bar{flex:1;height:8px;background:var(--sand-d);border-radius:20px;overflow:hidden;}
.budget-cat-fill{height:100%;background:linear-gradient(90deg,var(--ocean),var(--ocean-l));border-radius:20px;transition:width .4s;}
.budget-cat-lbl{font-size:.78rem;font-weight:700;color:var(--ink-m);white-space:nowrap;}
.budget-cat-amt{font-size:.78rem;font-weight:700;color:var(--coral);white-space:nowrap;}
@keyframes sway{0%,100%{transform:rotate(-4deg)}50%{transform:rotate(4deg)}}
/* Island body background ‚Äî subtle wave pattern */
body::before{content:'';position:fixed;inset:0;background:
  radial-gradient(ellipse at 85% 110%, rgba(46,156,191,.08) 0%, transparent 55%),
  radial-gradient(ellipse at 10% 90%, rgba(26,107,138,.06) 0%, transparent 50%);
pointer-events:none;z-index:0;}
.content{position:relative;z-index:1;}
/* Quick-access login bar */
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen on" id="s-login">
  <div class="wave"></div>
  <!-- floating sun decoration -->
  <div style="position:absolute;top:1.5rem;right:2rem;font-size:3rem;opacity:.5;pointer-events:none;animation:sway 4s ease-in-out infinite;">‚òÄÔ∏è</div>
  <div style="position:absolute;top:3rem;left:1.5rem;font-size:1.8rem;opacity:.35;pointer-events:none;animation:sway 5s ease-in-out infinite reverse;">üêö</div>
  <!-- LOGIN PANEL -->
  <div class="auth-card" id="panel-login">
    <div id="firebase-warn" style="display:none;background:#FEF3C7;border:2px solid #F59E0B;border-radius:var(--rs);padding:.875rem 1rem;margin-bottom:1rem;font-size:.82rem;color:#92400E;font-weight:600;line-height:1.5;">
      ‚ö†Ô∏è <strong>Firebase not configured.</strong> Open the HTML file and paste your Firebase project credentials into the <code>FIREBASE_CONFIG</code> object near the top of the &lt;script&gt; tag. See the README below the login for setup steps.
    </div>
    <div class="auth-logo">Reynolds<span>Hub</span></div>
    <div class="auth-sub">Sign in to your family account</div>
    <div class="auth-err" id="login-err"></div>
    <div class="fld"><label>Username</label><input id="l-user" placeholder="sreynolds" autocomplete="username"></div>
    <div class="fld"><label>Password</label><input id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="btn btn-forest" onclick="doLogin()">Sign In</button>
    <div class="auth-link">New family? <a onclick="showPanel('signup')">Request an account ‚Üí</a></div>
  </div>

  <!-- SIGNUP REQUEST PANEL -->
  <div class="auth-card" id="panel-signup" style="display:none">    <div class="auth-logo">Reynolds<span>Hub</span></div>
    <div class="auth-sub">Request a new family account ‚Äî the admin will approve it shortly.</div>
    <div class="auth-err" id="signup-err"></div>
    <div class="auth-ok" id="signup-ok"></div>
    <div class="fld"><label>Your Full Name</label><input id="su-name" placeholder="Jane Reynolds"></div>
    <div class="fld"><label>Desired Username</label><input id="su-user" placeholder="jreynolds" autocomplete="off"></div>
    <div class="fld"><label>Family Name / Group</label><input id="su-family" placeholder="Reynolds Family"></div>
    <div class="fld"><label>Why do you want access?</label><textarea id="su-reason" rows="2" placeholder="I'm part of the Reynolds family‚Ä¶" style="resize:none"></textarea></div>
    <button class="btn btn-forest" onclick="doSignupRequest()">Send Request</button>
    <button class="btn btn-outline" onclick="showPanel('login')">‚Üê Back to Sign In</button>
  </div>

  <!-- FIREBASE SETUP GUIDE (shown below auth card) -->
  <div id="setup-guide" style="max-width:400px;width:100%;position:relative;z-index:1;margin-top:1.25rem;display:none;">
    <div style="background:rgba(255,255,255,.12);border-radius:var(--r);padding:1.25rem;color:#fff;font-size:.82rem;line-height:1.7;backdrop-filter:blur(4px);">
      <div style="font-family:'Fraunces',serif;font-size:1rem;font-weight:700;margin-bottom:.75rem;">üîß Firebase Setup (one-time)</div>
      <ol style="padding-left:1.25rem;display:flex;flex-direction:column;gap:.4rem;">
        <li>Go to <strong>console.firebase.google.com</strong> and create a free project</li>
        <li>In the project: <strong>Firestore Database</strong> ‚Üí Create database ‚Üí Start in <em>test mode</em></li>
        <li><strong>Project Settings</strong> ‚Üí Your apps ‚Üí Add Web app ‚Üí copy the config object</li>
        <li>Open <code>family-hub.html</code> in a text editor and paste values into <code>FIREBASE_CONFIG</code> at the top of the &lt;script&gt;</li>
        <li>Deploy to Vercel ‚Äî done! Default login: <code>sreynolds / password123</code></li>
      </ol>
      <div style="margin-top:.75rem;opacity:.75;font-size:.75rem;">Free Spark plan is plenty for a family ‚Äî no credit card needed.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="s-app">
  <div class="topbar">
    <div class="topbar-title">Reynolds<span>Hub</span></div>
    <div class="topbar-right">
      <div class="user-pill" id="user-pill" onclick="toggleDrop()">
        <div class="user-av" id="user-av">F</div>
        <span class="user-name" id="user-display">Family</span>
        <div class="dropdown" id="user-drop">
          <div class="dd-item" id="drop-family" style="color:var(--ink-l);font-size:.78rem;cursor:default"></div>
          <div class="dd-sep"></div>
          <div class="dd-item danger" onclick="doLogout()">Sign Out</div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- CALENDAR -->
    <div class="sec on" id="sec-cal">
      <!-- Today Hero strip -->
      <div id="cal-hero" style="background:linear-gradient(135deg,#0D4F6E,#1A6B8A,#2E9CBF);border-radius:var(--r);padding:1.1rem 1.25rem;margin-bottom:.875rem;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:1rem;">
        <div>
          <div id="cal-hero-date" style="font-family:'Fraunces',serif;font-size:1.3rem;font-weight:900;line-height:1.1;"></div>
          <div id="cal-hero-sub" style="font-size:.8rem;opacity:.8;margin-top:.2rem;"></div>
        </div>
        <div id="cal-weather-wrap" style="text-align:right;">
          <div id="cal-weather-temp" style="font-family:'Fraunces',serif;font-size:1.6rem;font-weight:900;line-height:1;"></div>
          <div id="cal-weather-desc" style="font-size:.72rem;opacity:.8;margin-top:1px;"></div>
        </div>
      </div>
      <div class="card">
        <div class="cal-nav">
          <button class="cnav" onclick="cm(-1)">&#8249;</button>
          <div class="cal-m" id="cal-lbl"></div>
          <div style="display:flex;align-items:center;gap:.5rem;">
            <div id="gcal-cal-indicator" style="display:none;font-size:.65rem;font-weight:800;padding:2px 8px;border-radius:20px;background:#E8F0FE;color:#4285F4;">üìÖ Google</div>
            <button class="cnav" onclick="cm(1)">&#8250;</button>
          </div>
        </div>
        <div class="cgrid" id="cal-grid"></div>
      </div>
      <div class="card">
        <div class="card-row">
          <div class="card-title" id="ev-date-lbl">üóì Upcoming Events</div>
          <button class="btn-sm btn-sm-forest" onclick="openModal('ev')">+ Add Event</button>
        </div>
        <div id="ev-list"></div>
      </div>
    </div>

    <!-- MEALS -->
    <div class="sec" id="sec-meals">
      <div class="card-row">
        <div class="card-title" style="font-family:'Fraunces',serif;font-size:1.2rem">üçΩÔ∏è This Week</div>
        <div style="display:flex;gap:.5rem">
          <button class="btn-sm" style="background:linear-gradient(135deg,#0D4F6E,var(--ocean));color:var(--white)" onclick="goSec('helper',document.getElementById('nb-helper'))">ü§ñ AI Plan</button>
          <button class="btn-sm btn-sm-forest" onclick="openModal('meal')">+ Add</button>
          <button class="btn-sm btn-sm-ghost" onclick="clearMeals()" title="Clear all meals this week">üóë Clear</button>
        </div>
      </div>
      <div id="meal-list" style="margin-top:.75rem"></div>
    </div>

    <!-- AI CHEF -->
    <div class="sec" id="sec-helper">
      <div class="helper-hero">
        <div class="helper-hero-ico">ü§ñ</div>
        <div><h2>Helper AI</h2><p>Tell me your family's tastes ‚Äî I'll plan the week &amp; auto-fill your shopping list!</p></div>
      </div>
      <div class="qchips">
        <button class="qchip" onclick="qp('Plan a healthy week of family dinners')">ü•ó Meals</button>
        <button class="qchip" onclick="qp('Quick meals under 30 mins each night')">‚ö° Quick meals</button>
        <button class="qchip" onclick="qp('Kid-friendly meals everyone will love')">üë∂ Kid-friendly</button>
        <button class="qchip" onclick="qp('Budget-friendly meals for the week')">üí∞ Budget meals</button>
        <button class="qchip" onclick="qp('Create a 7-day workout schedule for the whole family')">üí™ Workouts</button>
        <button class="qchip" onclick="qp('Plan 5 weekday workouts for an adult, mix of cardio and strength')">üèÉ Adult fitness</button>
        <button class="qchip" onclick="qp('Kid-friendly active activities for the week')">üßí Kids active</button>
      </div>
      <div class="chatbox">
        <div class="msgs" id="msgs"></div>
        <div class="chat-input-row">
          <input class="cinput" id="cinput" placeholder="e.g. plan meals and workouts for a family of 4‚Ä¶" onkeydown="if(event.key==='Enter'){event.preventDefault();sendMsg()}">
          <button class="csend" id="csend" onclick="sendMsg()">&#10148;</button>
        </div>
      </div>
      <div class="ai-plan-card" id="ai-plan-card">
        <div class="ai-plan-hdr">
          <div class="ai-plan-hdr-t">üçΩÔ∏è Your AI Meal Plan</div>
          <button class="apply-btn" onclick="applyPlan()">‚úÖ Apply to Meals + Shopping</button>
        </div>
        <div class="ai-plan-body">
          <div id="ai-meal-prev"></div>
          <div class="ai-shop-preview">
            <div class="ai-shop-t">üõí Shopping list will include</div>
            <div class="ai-tags" id="ai-shop-tags"></div>
          </div>
        </div>
      </div>
      <!-- Workout plan card -->
      <div class="ai-plan-card" id="ai-workout-card">
        <div class="ai-plan-hdr" style="background:linear-gradient(135deg,#1B4A2E,#2E7D52);">
          <div class="ai-plan-hdr-t">üí™ Your AI Workout Plan</div>
          <button class="apply-btn" onclick="applyWorkoutPlan()">‚úÖ Save to Workouts</button>
        </div>
        <div class="ai-plan-body">
          <div id="ai-workout-prev"></div>
        </div>
      </div>
    </div>

    <!-- SHOPPING -->
    <div class="sec" id="sec-shop">
      <div class="card">
        <div class="card-row">
          <div class="card-title">üõí Shopping List</div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn-sm btn-sm-ghost" onclick="checkAllShop()" title="Check everything off">‚úì All</button>
            <button class="btn-sm btn-sm-ghost" onclick="clearDoneShop()" title="Remove checked items">üóë Done</button>
            <button class="btn-sm btn-sm-ghost" onclick="clearAllShop()" title="Clear entire list">üóë All</button>
            <button class="btn-sm btn-sm-forest" onclick="openModal('shop')">+ Add</button>
          </div>
        </div>
        <div class="pbar-lbl" id="shop-lbl">0 of 0 items</div>
        <div class="pbar-wrap"><div class="pbar-fill" id="shop-bar" style="width:0%"></div></div>
        <div id="shop-list"></div>
      </div>
    </div>

    <!-- NOTES -->
    <div class="sec" id="sec-notes">
      <div class="card-row">
        <div class="card-title" style="font-family:'Fraunces',serif;font-size:1.2rem">üìù Family Board</div>
        <button class="btn-sm btn-sm-forest" onclick="openModal('note')">+ Post</button>
      </div>
      <div id="notes-list" style="margin-top:.75rem"></div>
    </div>

    <!-- CONTACTS -->
    <div class="sec" id="sec-contacts">
      <div class="card-row">
        <div class="card-title" style="font-family:'Fraunces',serif;font-size:1.2rem">üìû Family Contacts</div>
        <button class="btn-sm btn-sm-forest" onclick="openModal('contact')">+ Add</button>
      </div>
      <!-- Quick emergency strip -->
      <div style="background:var(--coral-l);border:2px solid var(--coral);border-radius:var(--r);padding:.875rem 1rem;margin-bottom:.875rem;display:flex;align-items:center;gap:.75rem;">
        <span style="font-size:1.4rem;">üö®</span>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:.85rem;color:var(--coral);">Emergency</div>
          <div style="font-size:.78rem;color:var(--ink-m);margin-top:1px;">Police / Fire / Ambulance</div>
        </div>
        <a href="tel:911" style="background:var(--coral);color:#fff;border-radius:var(--rs);padding:.45rem .875rem;font-weight:800;font-size:.85rem;text-decoration:none;">üìû 911</a>
      </div>
      <!-- Groups: Medical, School, Family, Other -->
      <div id="contacts-list"></div>
    </div>

    <!-- WORKOUT -->
    <div class="sec" id="sec-workout">
      <div class="card-row">
        <div class="card-title" style="font-family:'Fraunces',serif;font-size:1.2rem">üí™ Workouts</div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
          <button class="btn-sm" style="background:linear-gradient(135deg,#0D4F6E,var(--ocean));color:var(--white)" onclick="goSec('helper',document.getElementById('nb-helper'))">ü§ñ AI Plan</button>
          <button class="btn-sm btn-sm-forest" onclick="openWorkoutModal()">+ Add Workout</button>
        </div>
      </div>
      <div id="workout-member-tabs" style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0;"></div>
      <div id="workout-list-area"></div>
    </div>

    <!-- ADMIN -->
    <div class="sec" id="sec-admin">
      <div class="admin-hero">
        <div class="admin-hero-ico">‚öôÔ∏è</div>
        <div><h2>Admin Panel</h2><p>Manage accounts, approve requests &amp; see app stats</p></div>
      </div>
      <div class="stats-grid">
        <div class="admin-stat"><div class="admin-stat-n" id="stat-users">0</div><div class="admin-stat-l">Users</div></div>
        <div class="admin-stat"><div class="admin-stat-n" id="stat-families">0</div><div class="admin-stat-l">Families</div></div>
        <div class="admin-stat"><div class="admin-stat-n" id="stat-pending">0</div><div class="admin-stat-l">Pending</div></div>
      </div>
      <div class="card">
        <div class="card-row">
          <div class="card-title">‚è≥ Pending Requests</div>
        </div>
        <div id="pending-list"></div>
      </div>
      <div class="card">
        <div class="card-row">
          <div class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Members</div>
          <button class="btn-sm btn-sm-forest" onclick="openModal('member')">+ Add Member</button>
        </div>
        <div id="members-list"></div>
      </div>
      <!-- Google Calendar Card -->
      <div class="card" id="gcal-admin-card">
        <div class="card-row">
          <div class="card-title">üìÖ Google Calendar</div>
          <div id="gcal-status-badge" style="font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:20px;background:var(--sand-d);color:var(--ink-l);">Not connected</div>
        </div>
        <div id="gcal-connected-info" style="display:none;margin-bottom:.875rem;">
          <div style="font-size:.85rem;color:var(--ink-m);line-height:1.6;" id="gcal-cal-name"></div>
          <div style="display:flex;gap:.5rem;margin-top:.625rem;flex-wrap:wrap;">
            <button onclick="gcalSync()" style="background:var(--forest);color:#fff;border:none;border-radius:var(--rs);padding:.45rem .875rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;">‚Üª Sync Now</button>
            <button onclick="gcalDisconnect()" style="background:var(--rose-l);color:var(--rose);border:2px solid var(--rose);border-radius:var(--rs);padding:.45rem .875rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;">‚úï Disconnect</button>
          </div>
        </div>
        <div id="gcal-connect-area">
          <div style="font-size:.82rem;color:var(--ink-m);line-height:1.6;margin-bottom:.875rem;">Connect your <strong>Our Lovely Life</strong> Google Calendar. Events will appear on the ReynoldsHub calendar (shown in blue) and new events you add here will sync back to Google.</div>
          <button onclick="gcalConnect()" style="background:#4285F4;color:#fff;border:none;border-radius:var(--rs);padding:.6rem 1.25rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.875rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;">
            <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4A90D9" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.37-.76-2.84-.76-4.59s.27-3.22.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Connect Google Calendar
          </button>
        </div>
        <div id="gcal-sync-status" style="font-size:.75rem;color:var(--ink-l);margin-top:.5rem;min-height:1rem;"></div>
      </div>
      <div class="card">
        <div class="card-row">
          <div class="card-title">ü§ñ Helper AI Settings</div>
        </div>
        <div style="font-size:.85rem;color:var(--ink-m);line-height:1.6;margin-bottom:.875rem;">
          The API key is stored securely as a <strong>Vercel Environment Variable</strong> ‚Äî never in your code or database.<br>
          <span style="font-size:.78rem;color:var(--ink-l);">Vercel Dashboard ‚Üí Your Project ‚Üí Settings ‚Üí Environment Variables ‚Üí add <code>ANTHROPIC_API_KEY</code></span>
        </div>
        <div id="admin-anthropic-status" style="font-size:.78rem;font-weight:600;padding:.25rem 0;"></div>
        <button onclick="testAnthropicKey()" style="margin-top:.5rem;background:var(--sand);border:2px solid var(--sand-d);border-radius:var(--rs);padding:.45rem .875rem;font-family:'DM Sans',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;color:var(--ink-m);">üîå Test Connection</button>
      </div>
      <div class="card">
        <div class="card-row">
          <div class="card-title">üë• All Users</div>
          <button class="btn-sm btn-sm-forest" onclick="openModal('newuser')">+ Create User</button>
        </div>
        <div id="all-users-list"></div>
      </div>
    </div>
  </div>

  <nav class="bottomnav" id="bottomnav">
    <button class="nb" id="nb-cal" onclick="goSec('cal',this)"><span class="ni">üìÖ</span>Calendar</button>
    <button class="nb" id="nb-meals" onclick="goSec('meals',this)"><span class="ni">üçΩÔ∏è</span>Meals</button>
    <button class="nb" id="nb-shop" onclick="goSec('shop',this)"><span class="ni">üõí</span>Shopping</button>
    <button class="nb" id="nb-workout" onclick="goSec('workout',this)"><span class="ni">üí™</span>Workouts</button>
    <button class="nb" id="nb-contacts" onclick="goSec('contacts',this)"><span class="ni">üìû</span>Contacts</button>
    <button class="nb" id="nb-notes" onclick="goSec('notes',this)"><span class="ni">üìù</span>Board</button>
    <button class="nb" id="nb-helper" onclick="goSec('helper',this)"><span class="ni">ü§ñ</span>Helper AI</button>
    <button class="nb" id="nb-admin" onclick="goSec('admin',this)" style="display:none">
      <div class="nb-wrap"><span class="ni">‚öôÔ∏è</span><span class="nb-badge" id="admin-badge" style="display:none"></span></div>Admin
    </button>
  </nav>
</div>

<!-- SLIDESHOW OVERLAY -->
<div id="slideshow" style="display:none;position:fixed;inset:0;background:#000;z-index:600;flex-direction:column;user-select:none;">

  <!-- Top bar: clock + controls -->
  <div id="ss-topbar" style="position:absolute;top:0;left:0;right:0;z-index:10;padding:1.25rem 1.5rem;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent);transition:opacity .4s;">
    <div style="display:flex;flex-direction:column;">
      <div id="ss-clock" style="font-family:'Fraunces',serif;font-size:2.5rem;font-weight:900;color:#fff;line-height:1;"></div>
      <div id="ss-date" style="font-size:.9rem;color:rgba(255,255,255,.7);margin-top:2px;font-weight:500;"></div>
    </div>
    <div style="display:flex;gap:.75rem;align-items:center;">
      <button id="ss-playbtn" onclick="ssTogglePlay()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:50%;width:44px;height:44px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">‚è∏</button>
      <button onclick="stopSlideshow()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:50%;width:44px;height:44px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">‚úï</button>
    </div>
  </div>

  <!-- Photo display -->
  <div style="flex:1;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;" id="ss-stage">
    <img id="ss-img-a" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;transition:opacity .8s ease;" src="" alt="">
    <img id="ss-img-b" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;transition:opacity .8s ease;opacity:0;" src="" alt="">

    <!-- Prev / Next tap zones -->
    <div onclick="ssPrev()" style="position:absolute;left:0;top:0;bottom:0;width:20%;cursor:pointer;display:flex;align-items:center;padding-left:1rem;">
      <div style="background:rgba(255,255,255,.12);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;backdrop-filter:blur(4px);">‚Äπ</div>
    </div>
    <div onclick="ssNext()" style="position:absolute;right:0;top:0;bottom:0;width:20%;cursor:pointer;display:flex;align-items:center;justify-content:flex-end;padding-right:1rem;">
      <div style="background:rgba(255,255,255,.12);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;backdrop-filter:blur(4px);">‚Ä∫</div>
    </div>
  </div>

  <!-- Bottom bar: caption + dots -->
  <div id="ss-botbar" style="position:absolute;bottom:0;left:0;right:0;padding:1.5rem;background:linear-gradient(to top,rgba(0,0,0,.7),transparent);transition:opacity .4s;">
    <div id="ss-caption" style="color:#fff;font-size:1rem;font-weight:600;text-align:center;text-shadow:0 1px 4px rgba(0,0,0,.5);margin-bottom:.75rem;min-height:1.4rem;"></div>
    <div id="ss-dots" style="display:flex;justify-content:center;gap:6px;flex-wrap:wrap;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- Event -->
<div class="ov" id="ov-ev"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üìÖ Add Event</div>
  <div class="fld"><label>Event Name</label><input class="fi" id="ev-n" placeholder="Soccer practice, Doctor appt‚Ä¶"></div>
  <div class="fr">
    <div class="fld"><label>Start Date</label><input class="fi" id="ev-start" type="date"></div>
    <div class="fld"><label>End Date <span style="font-weight:400;opacity:.6">(optional)</span></label><input class="fi" id="ev-end" type="date"></div>
  </div>
  <div class="fld">
    <label>Time</label>
    <div style="display:flex;gap:.375rem;align-items:center;">
      <input class="fi" id="ev-th" type="number" min="1" max="12" placeholder="--" style="width:52px;padding:.75rem .5rem;text-align:center;">
      <span style="font-weight:700;color:var(--ink-l);">:</span>
      <select class="fi" id="ev-tm" style="width:72px;padding:.75rem .375rem;">
        <option value="">--</option><option>00</option><option>15</option><option>30</option><option>45</option>
      </select>
      <select class="fi" id="ev-tampm" style="width:70px;padding:.75rem .375rem;">
        <option>AM</option><option selected>PM</option>
      </select>
    </div>
  </div>
  <div class="fr">
    <div class="fld"><label>Who</label><select class="fi" id="ev-w"><option value="">Everyone</option></select></div>
    <div class="fld"><label>Color</label>
      <div class="cpick" id="ev-cpick">
        <div class="copt on" data-c="dot-or" onclick="pickCol(this)" style="background:#E9854C"></div>
        <div class="copt" data-c="dot-gr" onclick="pickCol(this)" style="background:#40916C"></div>
        <div class="copt" data-c="dot-bl" onclick="pickCol(this)" style="background:#4C89C8"></div>
        <div class="copt" data-c="dot-pk" onclick="pickCol(this)" style="background:#C75B5B"></div>
        <div class="copt" data-c="dot-ye" onclick="pickCol(this)" style="background:#E9A84C"></div>
      </div>
    </div>
  </div>
  <div class="fld"><label>Repeats</label>
    <div class="chips">
      <div class="chip on" data-v="none" onclick="pickChip(this,'ev-repeat');document.getElementById('ev-repeat-end-row').style.display='none'">üö´ None</div>
      <div class="chip" data-v="daily" onclick="pickChip(this,'ev-repeat');document.getElementById('ev-repeat-end-row').style.display=''">üìÜ Daily</div>
      <div class="chip" data-v="weekly" onclick="pickChip(this,'ev-repeat');document.getElementById('ev-repeat-end-row').style.display=''">üîÅ Weekly</div>
      <div class="chip" data-v="biweekly" onclick="pickChip(this,'ev-repeat');document.getElementById('ev-repeat-end-row').style.display=''">üîÅ Every 2 Wks</div>
      <div class="chip" data-v="monthly" onclick="pickChip(this,'ev-repeat');document.getElementById('ev-repeat-end-row').style.display=''">üìÖ Monthly</div>
    </div>
    <input type="hidden" id="ev-repeat" value="none">
  </div>
  <div class="fld" id="ev-repeat-end-row" style="display:none">
    <label>Repeat Until <span style="font-weight:400;opacity:.6">(end date)</span></label>
    <input class="fi" id="ev-repeat-end" type="date">
  </div>
  <button class="sbtn" onclick="addEvent()">Add Event üéâ</button>
</div></div>

<!-- Edit Event -->
<div class="ov" id="ov-evedit"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">‚úèÔ∏è Edit Event</div>
  <input type="hidden" id="eed-id">
  <div class="fld"><label>Name</label><input class="fi" id="eed-n" placeholder="Event name‚Ä¶"></div>
  <div class="fr">
    <div class="fld">
      <label>Time</label>
      <div style="display:flex;gap:.375rem;align-items:center;">
        <input class="fi" id="eed-th" type="number" min="1" max="12" placeholder="12" style="width:52px;padding:.75rem .5rem;text-align:center;">
        <span style="font-weight:700;color:var(--ink-l);">:</span>
        <input class="fi" id="eed-tm" type="number" min="0" max="59" placeholder="00" style="width:52px;padding:.75rem .5rem;text-align:center;">
        <select class="fi" id="eed-tampm" style="width:70px;padding:.75rem .375rem;">
          <option>AM</option><option>PM</option>
        </select>
      </div>
    </div>
    <div class="fld"><label>Who</label><select class="fi" id="eed-w"><option value="">Everyone</option></select></div>
  </div>
  <div class="fld"><label>Color</label>
    <div class="cpick" id="eed-cpick">
      <div class="copt on" data-c="dot-or" onclick="pickColEdit(this)" style="background:#E9854C"></div>
      <div class="copt" data-c="dot-gr" onclick="pickColEdit(this)" style="background:#40916C"></div>
      <div class="copt" data-c="dot-bl" onclick="pickColEdit(this)" style="background:#4C89C8"></div>
      <div class="copt" data-c="dot-pk" onclick="pickColEdit(this)" style="background:#C75B5B"></div>
      <div class="copt" data-c="dot-ye" onclick="pickColEdit(this)" style="background:#E9A84C"></div>
    </div>
  </div>
  <div class="fld"><label>Repeats</label>
    <div class="chips" id="eed-repeat-chips">
      <div class="chip on" data-v="none" onclick="pickChip(this,'eed-repeat')">üö´ None</div>
      <div class="chip" data-v="daily" onclick="pickChip(this,'eed-repeat')">üìÜ Daily</div>
      <div class="chip" data-v="weekly" onclick="pickChip(this,'eed-repeat')">üîÅ Weekly</div>
      <div class="chip" data-v="monthly" onclick="pickChip(this,'eed-repeat')">üìÖ Monthly</div>
    </div>
    <input type="hidden" id="eed-repeat" value="none">
  </div>
  <button class="sbtn" onclick="saveEventEdit()">Save Changes ‚úÖ</button>
</div></div>


<!-- Meal -->
<div class="ov" id="ov-meal"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üçΩÔ∏è Plan a Meal</div>
  <div class="fld"><label>Day</label>
    <select class="fi" id="ml-d">
      <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
      <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
    </select>
  </div>
  <div class="fld"><label>Meal</label>
    <div class="chips">
      <div class="chip on" data-v="breakfast" onclick="pickChip(this,'ml-s')">üåÖ Breakfast</div>
      <div class="chip" data-v="lunch" onclick="pickChip(this,'ml-s')">‚òÄÔ∏è Lunch</div>
      <div class="chip" data-v="dinner" onclick="pickChip(this,'ml-s')">üåô Dinner</div>
      <div class="chip" data-v="snack" onclick="pickChip(this,'ml-s')">üçé Snack</div>
    </div>
    <input type="hidden" id="ml-s" value="breakfast">
  </div>
  <div class="fld"><label>What?</label><input class="fi" id="ml-n" placeholder="Spaghetti bolognese‚Ä¶"></div>
  <button class="sbtn" onclick="addMeal()">Save Meal üçΩÔ∏è</button>
</div></div>

<!-- Shop -->
<div class="ov" id="ov-shop"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üõí Add Item</div>
  <div class="fld"><label>Item</label><input class="fi" id="sh-n" placeholder="Milk, Apples, Chicken‚Ä¶"></div>
  <div class="fld">
    <label>Quantity</label>
    <div style="display:flex;gap:.5rem;align-items:center;">
      <input class="fi" id="sh-amt" type="number" min="0.25" step="0.25" placeholder="1" style="width:80px;flex-shrink:0;">
      <select class="fi" id="sh-unit">
        <option value="item">item(s)</option>
        <option value="lb">lb(s)</option>
        <option value="oz">oz</option>
        <option value="gallon">gallon(s)</option>
        <option value="quart">quart(s)</option>
        <option value="pint">pint(s)</option>
        <option value="cup">cup(s)</option>
        <option value="fl oz">fl oz</option>
        <option value="tbsp">tbsp</option>
        <option value="tsp">tsp</option>
        <option value="dozen">dozen</option>
        <option value="bag">bag(s)</option>
        <option value="box">box(es)</option>
        <option value="can">can(s)</option>
        <option value="bunch">bunch(es)</option>
        <option value="loaf">loaf/loaves</option>
        <option value="pack">pack(s)</option>
        <option value="stick">stick(s)</option>
        <option value="slice">slice(s)</option>
      </select>
    </div>
  </div>
  <div class="fld"><label>Category</label>
    <select class="fi" id="sh-c">
      <option>ü•¶ Produce</option><option>ü•© Meat &amp; Fish</option><option>üßÄ Dairy</option>
      <option>ü•ñ Bakery</option><option>ü•´ Pantry</option><option>üßä Frozen</option>
      <option>üß¥ Household</option><option>üç≠ Snacks</option>
    </select>
  </div>
  <button class="sbtn" onclick="addShop()">Add to List üõí</button>
</div></div>

<!-- Meal edit -->
<div class="ov" id="ov-medit"><div class="modal">
  <div class="mhandle"></div><div class="mtitle" id="medit-title">Edit Meal</div>
  <input type="hidden" id="medit-day"><input type="hidden" id="medit-slot">
  <div class="fld"><label>What are you having?</label><input class="fi" id="medit-val" placeholder="Enter meal name‚Ä¶"></div>
  <button class="sbtn" onclick="saveMedit()">Save üçΩÔ∏è</button>
</div></div>

<!-- Note -->
<div class="ov" id="ov-note"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üìù Post to Family Board</div>
  <div class="fld"><label>Title</label><input class="fi" id="nt-t" placeholder="Weekend plans, Reminder‚Ä¶"></div>
  <div class="fld"><label>Message</label><textarea class="fi" id="nt-b" rows="3" placeholder="Write your message‚Ä¶" style="resize:none"></textarea></div>
  <div class="fld"><label>Options</label>
    <div class="chips">
      <div class="chip" data-v="pin" onclick="toggleChip(this)">üìå Pin to top</div>
    </div>
  </div>
  <button class="sbtn" onclick="addNote()">Post to Board üìù</button>
</div></div>

<!-- Photo caption -->
<div class="ov" id="ov-photo"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üì∏ Add Caption</div>
  <img id="photo-preview" style="width:100%;border-radius:var(--rs);margin-bottom:1rem;max-height:200px;object-fit:cover;" src="" alt="">
  <div class="fld"><label>Caption (optional)</label><input class="fi" id="photo-cap" placeholder="Summer 2025, Emma's birthday‚Ä¶"></div>
  <button class="sbtn" onclick="savePhoto()">Add to Memory Wall üì∏</button>
</div></div>

<!-- Contact -->
<div class="ov" id="ov-contact"><div class="modal">
  <div class="mhandle"></div><div class="mtitle" id="contact-modal-title">üìû Add Contact</div>
  <input type="hidden" id="ct-id">
  <div class="fld"><label>Name / Organization</label><input class="fi" id="ct-name" placeholder="Dr. Smith, Minnetonka School, Grandma‚Ä¶"></div>
  <div class="fld"><label>Category</label>
    <div class="chips" style="flex-wrap:wrap;">
      <div class="chip on" data-v="üè• Medical" onclick="pickChip(this,'ct-cat')">üè• Medical</div>
      <div class="chip" data-v="üè´ School" onclick="pickChip(this,'ct-cat')">üè´ School</div>
      <div class="chip" data-v="üë®‚Äçüë©‚Äçüëß Family" onclick="pickChip(this,'ct-cat')">üë®‚Äçüë©‚Äçüëß Family</div>
      <div class="chip" data-v="‚öΩ Sports" onclick="pickChip(this,'ct-cat')">‚öΩ Sports</div>
      <div class="chip" data-v="üîß Services" onclick="pickChip(this,'ct-cat')">üîß Services</div>
      <div class="chip" data-v="üì¶ Other" onclick="pickChip(this,'ct-cat')">üì¶ Other</div>
    </div>
    <input type="hidden" id="ct-cat" value="üè• Medical">
  </div>
  <div class="fld"><label>Phone</label><input class="fi" id="ct-phone" type="tel" placeholder="(555) 123-4567"></div>
  <div class="fld"><label>Role / Notes</label><input class="fi" id="ct-role" placeholder="Pediatrician, Emma's homeroom, Grandpa's cell‚Ä¶"></div>
  <div class="fld"><label>Address <span style="font-weight:400;opacity:.6">(optional)</span></label><input class="fi" id="ct-addr" placeholder="123 Main St, Minneapolis MN"></div>
  <button class="sbtn" onclick="saveContact()">Save Contact üìû</button>
</div></div>

<!-- Add Family Member -->
<div class="ov" id="ov-member"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üë§ Add Family Member</div>
  <div class="fld"><label>Name</label><input class="fi" id="mb-name" placeholder="Emma, Jack, Mom‚Ä¶"></div>
  <div class="fld"><label>Color</label>
    <div class="member-chip-pick" id="mb-color-pick">
      <div class="mcp on" data-c="#E9854C" onclick="pickMemberCol(this)" style="background:#E9854C">A</div>
      <div class="mcp" data-c="#40916C" onclick="pickMemberCol(this)" style="background:#40916C">A</div>
      <div class="mcp" data-c="#4C89C8" onclick="pickMemberCol(this)" style="background:#4C89C8">A</div>
      <div class="mcp" data-c="#C75B5B" onclick="pickMemberCol(this)" style="background:#C75B5B">A</div>
      <div class="mcp" data-c="#9B59B6" onclick="pickMemberCol(this)" style="background:#9B59B6">A</div>
      <div class="mcp" data-c="#E9A84C" onclick="pickMemberCol(this)" style="background:#E9A84C">A</div>
      <div class="mcp" data-c="#1ABC9C" onclick="pickMemberCol(this)" style="background:#1ABC9C">A</div>
      <div class="mcp" data-c="#E67E22" onclick="pickMemberCol(this)" style="background:#E67E22">A</div>
    </div>
    <input type="hidden" id="mb-color" value="#E9854C">
  </div>
  <button class="sbtn" onclick="addMember()">Add Member üë§</button>
</div></div>

<!-- Workout -->
<div class="ov" id="ov-workout"><div class="modal">
  <div class="mhandle"></div><div class="mtitle" id="workout-modal-title">üí™ Add Workout</div>
  <input type="hidden" id="wo-id">
  <div class="fld"><label>Workout Name</label><input class="fi" id="wo-name" placeholder="Morning Run, Chest Day, Yoga Flow‚Ä¶"></div>
  <div class="fr">
    <div class="fld"><label>Person</label><select class="fi" id="wo-who"><option value="">Everyone</option></select></div>
    <div class="fld"><label>Schedule Tag</label><input class="fi" id="wo-tag" placeholder="Mon/Wed/Fri, Daily‚Ä¶"></div>
  </div>
  <div class="fld"><label>Type</label>
    <div class="chips">
      <div class="chip on" data-v="strength" onclick="pickChip(this,'wo-type')">üèãÔ∏è Strength</div>
      <div class="chip" data-v="cardio" onclick="pickChip(this,'wo-type')">üèÉ Cardio</div>
      <div class="chip" data-v="flexibility" onclick="pickChip(this,'wo-type')">üßò Flexibility</div>
      <div class="chip" data-v="sports" onclick="pickChip(this,'wo-type')">‚öΩ Sports</div>
      <div class="chip" data-v="custom" onclick="pickChip(this,'wo-type')">‚úèÔ∏è Custom</div>
    </div>
    <input type="hidden" id="wo-type" value="strength">
  </div>
  <div class="fld"><label>Duration</label>
    <div class="chips">
      <div class="chip on" data-v="30" onclick="pickChip(this,'wo-dur')">30 min</div>
      <div class="chip" data-v="45" onclick="pickChip(this,'wo-dur')">45 min</div>
      <div class="chip" data-v="60" onclick="pickChip(this,'wo-dur')">60 min</div>
      <div class="chip" data-v="90" onclick="pickChip(this,'wo-dur')">90 min</div>
    </div>
    <input type="hidden" id="wo-dur" value="30">
  </div>
  <div class="fld"><label>Notes / Exercises</label><textarea class="fi" id="wo-notes" rows="3" placeholder="3x10 bench press, 20 min run, etc‚Ä¶" style="resize:none"></textarea></div>
  <button class="sbtn" onclick="saveWorkout()">Save Workout üí™</button>
</div></div>


<!-- Create User (admin) -->
<div class="ov" id="ov-newuser"><div class="modal">
  <div class="mhandle"></div><div class="mtitle">üë§ Create New Account</div>
  <div class="auth-err" id="newuser-err"></div>
  <div class="fld"><label>Display Name</label><input class="fi" id="nu-name" placeholder="Jane Reynolds"></div>
  <div class="fld"><label>Username</label><input class="fi" id="nu-user" placeholder="jreynolds"></div>
  <div class="fld"><label>Password</label><input class="fi" id="nu-pass" type="password" placeholder="Choose a password"></div>
  <div class="fld"><label>Family ID</label><input class="fi" id="nu-fam" placeholder="reynolds (lowercase, no spaces)"></div>
  <div class="fld"><label>Role</label>
    <div class="chips">
      <div class="chip on" data-v="member" onclick="pickChip(this,'nu-role')">üë§ Member</div>
      <div class="chip" data-v="admin" onclick="pickChip(this,'nu-role')">‚öôÔ∏è Admin</div>
    </div>
    <input type="hidden" id="nu-role" value="member">
  </div>
  <button class="sbtn" onclick="createUser()">Create Account üë§</button>
</div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var ADMIN_EMAIL = 'shawn.f.reynolds@gmail.com';
var DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
var dotColorMap = {'dot-or':'#E9854C','dot-gr':'#40916C','dot-bl':'#4C89C8','dot-pk':'#C75B5B','dot-ye':'#E9A84C'};
var SLOTS = ['breakfast','lunch','dinner','snack'];
var SICO = {breakfast:'üåÖ',lunch:'‚òÄÔ∏è',dinner:'üåô',snack:'üçé'};
var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

var session = {user: null}; // current logged-in user object
var viewY = new Date().getFullYear();
var viewM = new Date().getMonth();
var selDate = new Date();
var selCol = 'dot-or';
var selColEdit = 'dot-or'; // for edit event modal
var selMemberColor = '#E9854C';
var chatHist = [];
var pendingPlan = null;
var pendingWorkoutPlan = null;
var aiTyping = false;
var pendingPhotoData = null; // base64 data URL waiting for caption

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRYPTO ‚Äî SHA-256 password hashing
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sha256(str) {
  var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(function(b){return b.toString(16).padStart(2,'0');}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG ‚Äî paste your values here
// Get these from: console.firebase.google.com
// ‚Üí Your project ‚Üí Project Settings ‚Üí Your apps ‚Üí Web app ‚Üí SDK snippet
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAL06ZiKLTqTnA1X8azeiX16mBrwkMah-M",
  authDomain:        "myfamilyhub-b424b.firebaseapp.com",
  projectId:         "myfamilyhub-b424b",
  storageBucket:     "myfamilyhub-b424b.firebasestorage.app",
  messagingSenderId: "98166405229",
  appId:             "1:98166405229:web:ac0c88543999b6520f2764",
  measurementId:     "G-QVQDEB59G1"
};

// ‚îÄ‚îÄ Firebase SDK (loaded via CDN in <head>, see top of file) ‚îÄ‚îÄ
var _db = null;
function getDb() {
  if(_db) return _db;
  firebase.initializeApp(FIREBASE_CONFIG);
  _db = firebase.firestore();
  return _db;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE HELPERS  (same API as before, now backed by Firestore)
// All data lives in a single Firestore collection "kv" with doc id = key
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function stGet(key) {
  try {
    var doc = await getDb().collection('kv').doc(encodeKey(key)).get();
    return doc.exists ? doc.data().val : null;
  } catch(e) { console.error('stGet',key,e); return null; }
}
async function stSet(key, val) {
  try {
    await getDb().collection('kv').doc(encodeKey(key)).set({val: val});
    return true;
  } catch(e) { console.error('stSet',key,e); return false; }
}
async function stDel(key) {
  try { await getDb().collection('kv').doc(encodeKey(key)).delete(); } catch(e) {}
}
// Firestore doc IDs can't contain '/' ‚Äî encode colons and slashes
function encodeKey(k){ return k.replace(/\//g,'__sl__'); }

// Family-scoped helpers
async function famGet(key) { return stGet('fam:'+session.user.familyId+':'+key); }
async function famSet(key, val) { return stSet('fam:'+session.user.familyId+':'+key, val); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEED INITIAL USERS (first run only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function seedIfNeeded() {
  var existing = await stGet('user:sreynolds');
  if (existing) return; // already seeded

  var hash1 = await sha256('password123');
  var hash2 = await sha256('password456');

  await stSet('user:sreynolds', {
    username: 'sreynolds', passwordHash: hash1, familyId: 'reynolds',
    role: 'admin', displayName: 'Shawn Reynolds', approved: true,
    createdAt: Date.now()
  }, true);

  await stSet('user:jreynolds', {
    username: 'jreynolds', passwordHash: hash2, familyId: 'reynolds',
    role: 'member', displayName: 'J Reynolds', approved: true,
    createdAt: Date.now()
  }, true);

  // Seed some demo family data
  var today = new Date();
  function ds(o){var d=new Date(today);d.setDate(d.getDate()+o);return d.toISOString().split('T')[0];}
  var demoEvents = [
    {id:1, date:ds(0), title:'Soccer practice', time:'4:00 PM', who:'Emma', col:'dot-pk', colHex:'#C75B5B', repeat:'none', repeatId:null, addedBy:'sreynolds'},
    {id:2, date:ds(1), title:'Doctor checkup', time:'10:30 AM', who:'Jack', col:'dot-gr', colHex:'#40916C', repeat:'none', repeatId:null, addedBy:'sreynolds'},
    {id:3, date:ds(3), title:'School play', time:'3:00 PM', who:'Emma', col:'dot-pk', colHex:'#C75B5B', repeat:'none', repeatId:null, addedBy:'sreynolds'},
    {id:4, date:ds(5), title:"Liam's birthday party", time:'2:00 PM', who:'Jack', col:'dot-gr', colHex:'#40916C', repeat:'none', repeatId:null, addedBy:'sreynolds'}
  ];
  var demoTasks = [
    {id:1, title:'Clean bedroom', who:'Emma', pri:'h', done:false},
    {id:2, title:'Finish math homework', who:'Jack', pri:'h', done:false},
    {id:3, title:'Feed the dog', who:'Both', pri:'m', done:true},
    {id:4, title:'Pack school bag', who:'Emma', pri:'l', done:false}
  ];
  var demoMeals = {};
  DAYS.forEach(function(d){demoMeals[d]={breakfast:'',lunch:'',dinner:'',snack:''};});
  demoMeals.Monday.dinner='Spaghetti Bolognese üçù';
  demoMeals.Tuesday.dinner='Chicken Tacos üåÆ';
  demoMeals.Wednesday.dinner='Grilled Salmon üêü';
  demoMeals.Thursday.dinner='Homemade Pizza üçï';
  demoMeals.Friday.dinner='Fish & Chips üê†';
  demoMeals.Saturday.breakfast='Pancakes ü•û';
  demoMeals.Saturday.dinner='BBQ Burgers üçî';
  demoMeals.Sunday.dinner='Roast Chicken üçó';
  var demoShop = [
    {id:1,name:'Milk',qty:'1 gallon',cat:'üßÄ Dairy',done:false,ai:false},
    {id:2,name:'Chicken breast',qty:'2 lbs',cat:'ü•© Meat & Fish',done:false,ai:false},
    {id:3,name:'Broccoli',qty:'1 head',cat:'ü•¶ Produce',done:true,ai:false},
    {id:4,name:'Pasta',qty:'1 lb box',cat:'ü•´ Pantry',done:false,ai:false}
  ];
  var demoNotes = [
    {id:1, title:"Welcome to ReynoldsHub! üè†", body:"This is your family's private space. Add events, plan meals, share photos, and keep everyone in sync.", author:'sreynolds', pinned:true, createdAt:Date.now()},
    {id:2, title:"Grocery reminder", body:"We're out of milk and bread. Can someone pick these up this week?", author:'sreynolds', pinned:false, createdAt:Date.now()-3600000}
  ];
  await stSet('fam:reynolds:events', demoEvents);
  await stSet('fam:reynolds:tasks', demoTasks);
  await stSet('fam:reynolds:meals', demoMeals);
  await stSet('fam:reynolds:shopping', demoShop);
  await stSet('fam:reynolds:notes', demoNotes);
  await stSet('fam:reynolds:photos', []);
  var demoContacts = [
    {id:1, name:'Dr. Sarah Kim', cat:'üè• Medical', phone:'(952) 555-0191', role:'Family Pediatrician', addr:'345 Lake St, Minneapolis MN'},
    {id:2, name:'Minnetonka Elementary', cat:'üè´ School', phone:'(952) 555-0140', role:'Main office', addr:''},
    {id:3, name:'Grandpa Bill', cat:'üë®‚Äçüë©‚Äçüëß Family', phone:'(612) 555-0177', role:"Shawn's Dad", addr:''},
    {id:4, name:'Grandma Carol', cat:'üë®‚Äçüë©‚Äçüëß Family', phone:'(612) 555-0133', role:"Shawn's Mom", addr:''},
  ];
  await stSet('fam:reynolds:contacts', demoContacts);
  await stSet('fam:reynolds:members', [
    {id:1, name:'Shawn',  color:'#4C89C8'},
    {id:2, name:'Emma',   color:'#C75B5B'},
    {id:3, name:'Jack',   color:'#40916C'},
    {id:4, name:'Mom',    color:'#9B59B6'}
  ]);
  await stSet('pending:signups', []);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPanel(p) {
  document.getElementById('panel-login').style.display = p==='login'?'':'none';
  document.getElementById('panel-signup').style.display = p==='signup'?'':'none';
  clearAuthMsgs();
}
function clearAuthMsgs() {
  ['login-err','signup-err','signup-ok','newuser-err'].forEach(function(id){
    var el = document.getElementById(id);
    if(el){el.style.display='none';el.textContent='';}
  });
}
function showErr(id, msg) {
  var el = document.getElementById(id);
  if(el){el.textContent=msg;el.style.display='block';}
}
function showOk(id, msg) {
  var el = document.getElementById(id);
  if(el){el.textContent=msg;el.style.display='block';}
}

async function doLogin() {
  clearAuthMsgs();
  var username = document.getElementById('l-user').value.trim().toLowerCase();
  var password = document.getElementById('l-pass').value;
  if(!username||!password){showErr('login-err','Please enter username and password.');return;}
  var user = await stGet('user:'+username);
  if(!user){showErr('login-err','Account not found. Check your username.');return;}
  if(!user.approved){showErr('login-err','Your account is pending approval. The admin will activate it shortly.');return;}
  var hash = await sha256(password);
  if(hash !== user.passwordHash){showErr('login-err','Incorrect password. Please try again.');return;}
  session.user = user;
  launchApp();
}

async function doSignupRequest() {
  clearAuthMsgs();
  var name = document.getElementById('su-name').value.trim();
  var username = document.getElementById('su-user').value.trim().toLowerCase();
  var family = document.getElementById('su-family').value.trim();
  var reason = document.getElementById('su-reason').value.trim();
  if(!name||!username||!family){showErr('signup-err','Please fill in all required fields.');return;}
  if(!/^[a-z0-9_]{3,20}$/.test(username)){showErr('signup-err','Username must be 3-20 chars, letters/numbers/underscores only.');return;}
  var existing = await stGet('user:'+username);
  if(existing){showErr('signup-err','That username is already taken. Please choose another.');return;}
  var pending = await stGet('pending:signups') || [];
  if(pending.find(function(p){return p.username===username;})){showErr('signup-err','A request for that username is already pending.');return;}
  pending.push({username:username, displayName:name, familyName:family, reason:reason||'', requestedAt:Date.now()});
  await stSet('pending:signups', pending);
  showOk('signup-ok', '‚úÖ Request sent! The admin will review it and create your account. You\'ll be notified when it\'s ready.');
  // In a real app we'd send an email ‚Äî here we just log it
  console.log('New signup request for admin '+ADMIN_EMAIL+':', {username, name, family});
}

async function doLogout() {
  session.user = null;
  document.getElementById('s-app').classList.remove('on');
  document.getElementById('s-login').classList.add('on');
  document.getElementById('l-user').value='';
  document.getElementById('l-pass').value='';
  document.getElementById('user-drop').classList.remove('on');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function launchApp() {
  var u = session.user;
  document.getElementById('s-login').classList.remove('on');
  document.getElementById('s-app').classList.add('on');

  document.getElementById('user-av').textContent = u.displayName[0].toUpperCase();
  document.getElementById('user-display').textContent = u.displayName.split(' ')[0];
  document.getElementById('drop-family').textContent = u.familyId.charAt(0).toUpperCase()+u.familyId.slice(1)+' Family';

  // Admin tab
  if(u.role === 'admin') {
    document.getElementById('nb-admin').style.display = '';
    checkPendingBadge();
  }

  selDate = new Date();
  viewY = selDate.getFullYear();
  viewM = selDate.getMonth();

  await loadMembers();
  await populateMemberDropdowns();

  renderCal();
  await renderEvents();
  await renderMeals();
  await renderShop();
  await migrateShoppingToImperial();
  await renderShop(); // re-render after migration
  await renderNotes();
  await renderWorkouts();
  await renderContacts();
  initHelper();
  initCalHero();
  // Google Calendar ‚Äî check connection and handle OAuth redirect
  handleGcalRedirect();
  gcalCheckStatus().then(function(connected){
    if(connected) gcalSync();
  });
  // Activate calendar nav
  document.getElementById('nb-cal').classList.add('on');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goSec(name, btn) {
  document.querySelectorAll('.sec').forEach(function(s){s.classList.remove('on');});
  document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('on');});
  var secEl = document.getElementById('sec-'+name);
  if(secEl) secEl.classList.add('on');
  if(btn) btn.classList.add('on');
  if(name==='admin') { renderAdmin(); gcalCheckStatus(); }
  if(name==='workout') renderWorkouts();
  if(name==='contacts') renderContacts();
}
function toggleDrop(){document.getElementById('user-drop').classList.toggle('on');}
document.addEventListener('click',function(e){
  var pill=document.getElementById('user-pill');
  if(pill&&!pill.contains(e.target))document.getElementById('user-drop').classList.remove('on');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAMILY MEMBERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var membersCache = []; // [{id, name, color}]

async function loadMembers(){
  membersCache = await famGet('members') || [];
  return membersCache;
}

function getMemberColor(name){
  if(!name) return null;
  var m = membersCache.find(function(x){ return x.name === name; });
  return m ? m.color : null;
}

function memberSwatch(name, size){
  var color = getMemberColor(name);
  if(!color || !name) return '';
  var s = size || 20;
  return '<span style="display:inline-flex;align-items:center;justify-content:center;width:'+s+'px;height:'+s+'px;border-radius:50%;background:'+color+';color:#fff;font-weight:700;font-size:'+(s*0.45)+'px;flex-shrink:0;">'+name[0].toUpperCase()+'</span>';
}

function whoPill(name){
  if(!name) return '';
  var color = getMemberColor(name);
  if(color){
    return '<span class="t-who-colored" style="background:'+color+'">'+name+'</span>';
  }
  return '<span class="t-who">'+name+'</span>';
}

async function populateMemberDropdowns(){
  var members = await loadMembers();
  var opts = '<option value="">Everyone</option>' + members.map(function(m){
    return '<option value="'+m.name+'">'+m.name+'</option>';
  }).join('');
  // Add event modal dropdown
  ['ev-w','eed-w','tk-w'].forEach(function(id){
    var el = document.getElementById(id);
    if(el) el.innerHTML = opts;
  });
  // Wire sticky-color on add-event "who" dropdown
  var evW = document.getElementById('ev-w');
  if(evW) evW.onchange = function(){
    var mc = getMemberColor(this.value);
    if(mc){
      // Find the dot class that maps to this color, or just store hex
      // Deselect all color opts ‚Äî member color overrides
      document.querySelectorAll('#ev-cpick .copt').forEach(function(o){o.classList.remove('on');});
    }
  };
  // Wire sticky-color on edit-event "who" dropdown
  var eedW = document.getElementById('eed-w');
  if(eedW) eedW.onchange = function(){
    var mc = getMemberColor(this.value);
    if(mc){
      document.querySelectorAll('#eed-cpick .copt').forEach(function(o){o.classList.remove('on');});
    }
  };
}

async function renderMembers(){
  var members = await loadMembers();
  var list = document.getElementById('members-list');
  if(!list) return;
  if(!members.length){
    list.innerHTML = '<div class="empty"><span class="empty-ico">üë®‚Äçüë©‚Äçüëß</span>No members yet ‚Äî add your family!</div>';
    return;
  }
  list.innerHTML = members.map(function(m){
    return '<div class="member-row"><div class="member-swatch" style="background:'+m.color+'">'+m.name[0].toUpperCase()+'</div><div class="member-row-info"><div class="member-row-name">'+m.name+'</div></div><button class="xbtn" onclick="delMember('+m.id+')">‚úï</button></div>';
  }).join('');
}

function pickMemberCol(el){
  document.querySelectorAll('.mcp').forEach(function(o){o.classList.remove('on');});
  el.classList.add('on');
  selMemberColor = el.getAttribute('data-c');
  // update letter in each swatch
  var nameVal = (document.getElementById('mb-name')||{}).value||'A';
  document.querySelectorAll('.mcp').forEach(function(o){ o.textContent = nameVal[0]||'A'; });
}

async function addMember(){
  var name = document.getElementById('mb-name').value.trim();
  if(!name){alert('Enter a name');return;}
  var members = await famGet('members') || [];
  members.push({id:Date.now(), name:name, color:selMemberColor});
  await famSet('members', members);
  membersCache = members;
  closeModals();
  renderMembers();
  populateMemberDropdowns();
  // reset
  document.getElementById('mb-name').value = '';
  selMemberColor = '#E9854C';
  document.querySelectorAll('.mcp').forEach(function(o,i){ o.classList.toggle('on', i===0); });
}

async function delMember(id){
  var members = await famGet('members') || [];
  await famSet('members', members.filter(function(m){return m.id!==id;}));
  membersCache = await famGet('members') || [];
  renderMembers();
  populateMemberDropdowns();
}

// Update member letter previews as user types name
document.addEventListener('DOMContentLoaded', function(){
  var nameInput = document.getElementById('mb-name');
  if(nameInput) nameInput.addEventListener('input', function(){
    var letter = this.value[0] ? this.value[0].toUpperCase() : 'A';
    document.querySelectorAll('.mcp').forEach(function(o){ o.textContent = letter; });
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCal() {
  document.getElementById('cal-lbl').textContent = MONTHS[viewM]+' '+viewY;
  var g = document.getElementById('cal-grid');
  g.innerHTML = '';
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(function(d){g.innerHTML+='<div class="cdh">'+d+'</div>';});
  var fd=new Date(viewY,viewM,1).getDay(), dim=new Date(viewY,viewM+1,0).getDate(), pd=new Date(viewY,viewM,0).getDate();
  var today=new Date();
  for(var i=fd-1;i>=0;i--) g.innerHTML+='<div class="cd dim">'+(pd-i)+'</div>';
  for(var d=1;d<=dim;d++) {
    var ds=viewY+'-'+pad(viewM+1)+'-'+pad(d);
    var isT=today.getDate()===d&&today.getMonth()===viewM&&today.getFullYear()===viewY;
    var isS=selDate&&selDate.getDate()===d&&selDate.getMonth()===viewM&&selDate.getFullYear()===viewY;
    var cls='cd';
    if(isT)cls+=' today'; else if(isS)cls+=' sel';
    // event dots checked async ‚Äî use data attribute
    g.innerHTML+='<div class="'+cls+'" data-ds="'+ds+'" onclick="pickDay('+d+')">'+d+'</div>';
  }
  var rem=(fd+dim)%7===0?0:7-((fd+dim)%7);
  for(var d=1;d<=rem;d++) g.innerHTML+='<div class="cd dim">'+d+'</div>';
  // Load events ‚Üí colored member pip dots
  getAllEvents().then(function(evs){
    if(!evs) return;
    var byDate = {};
    evs.forEach(function(ev){
      if(!byDate[ev.date]) byDate[ev.date] = [];
      byDate[ev.date].push(ev);
    });
    Object.keys(byDate).forEach(function(ds){
      var cell = g.querySelector('[data-ds="'+ds+'"]');
      if(!cell) return;
      var wrap = document.createElement('div');
      wrap.className = 'cal-dots';
      var seen = new Set();
      byDate[ds].forEach(function(ev){
        var color = ev.colHex || dotColorMap[ev.col] || '#8AA5B5';
        if(!seen.has(color)){
          seen.add(color);
          var pip = document.createElement('span');
          pip.className = 'cal-dot-pip';
          pip.style.background = color;
          wrap.appendChild(pip);
        }
      });
      cell.style.position = 'relative';
      cell.appendChild(wrap);
    });
  });
}
function pad(n){return String(n).padStart(2,'0');}
function cm(dir){
  viewM+=dir;
  if(viewM>11){viewM=0;viewY++;}else if(viewM<0){viewM=11;viewY--;}
  renderCal();
}
function pickDay(d){
  selDate=new Date(viewY,viewM,d);
  renderCal();
  renderEvents();
}

function evDotHtml(e){
  if(e.colHex) return '<div class="ev-dot" style="background:'+e.colHex+'"></div>';
  return '<div class="ev-dot '+(e.col||'dot-or')+'"></div>';
}
async function renderEvents() {
  var evs = await getAllEvents();
  var list = document.getElementById('ev-list');
  var DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var MN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var todayDs = new Date().toISOString().split('T')[0];
  // Next 12 upcoming events from today, sorted by date
  var upcoming = evs.filter(function(e){ return e.date >= todayDs; });
  upcoming.sort(function(a,b){ return a.date<b.date?-1:a.date>b.date?1:0; });
  upcoming = upcoming.slice(0,12);
  document.getElementById('ev-date-lbl').textContent = 'üóì Upcoming Events';
  if(!upcoming.length){list.innerHTML='<div class="empty"><span class="empty-ico">üì≠</span>No upcoming events ‚Äî add one!</div>';return;}
  var lastDate='';
  list.innerHTML=upcoming.map(function(e){
    var ds=e.date;
    var dateObj=new Date(ds+'T12:00:00');
    var isT=ds===todayDs;
    var header='';
    if(ds!==lastDate){
      lastDate=ds;
      var lbl=isT?'Today ‚Äî '+MN[dateObj.getMonth()]+' '+dateObj.getDate()
        :DN[dateObj.getDay()]+', '+MN[dateObj.getMonth()]+' '+dateObj.getDate();
      header='<div class="ev-date-sep">'+lbl+'</div>';
    }
    var whoTag=e.who?' &nbsp;'+whoPill(e.who):'';
    var repeatIcon=e.repeatId?' <span style="font-size:.68rem;color:var(--ink-l)">üîÅ</span>':'';
    var gcalBadge=e.fromGCal?' <span style="font-size:.6rem;font-weight:800;padding:1px 6px;border-radius:20px;background:#E8F0FE;color:#4285F4;vertical-align:middle;">G</span>':'';
    var delArg=e.repeatId?e.id+',\''+e.repeatId+'\'':e.id;
    var actionBtns = e.fromGCal
      ? '<span style="font-size:.68rem;color:var(--ink-l);padding:0 4px;">Google Cal</span>'
      : '<button class="xbtn" style="opacity:.5;font-size:.8rem" title="Edit" onclick="openEventEdit('+e.id+')">‚úèÔ∏è</button>'
        +'<button class="xbtn" onclick="delEvent('+delArg+')">‚úï</button>';
    return header
      +'<div class="ev-item">'
      +evDotHtml(e)
      +'<div class="ev-info"><div class="ev-name">'+e.title+gcalBadge+repeatIcon+'</div>'
      +'<div class="ev-meta">'+(e.time?'‚è∞ '+e.time:'')+whoTag+'</div></div>'
      +actionBtns
      +'</div>';
  }).join('');
}

async function addEvent() {
  var name=document.getElementById('ev-n').value.trim();
  if(!name){alert('Please enter an event name');return;}
  var startDate=document.getElementById('ev-start').value || (selDate||new Date()).toISOString().split('T')[0];
  var endDate=document.getElementById('ev-end').value || startDate;
  var h=document.getElementById('ev-th').value.trim();
  var m=document.getElementById('ev-tm').value;
  var ampm=document.getElementById('ev-tampm').value;
  var timeStr='';
  if(h){var mm=m||'00';timeStr=h+':'+mm+' '+ampm;}
  var who=document.getElementById('ev-w').value;
  var mc=getMemberColor(who);
  var colHex=mc||null;
  var col=selCol;
  var repeat=document.getElementById('ev-repeat').value;
  var repeatEndRaw=document.getElementById('ev-repeat-end').value;
  var repeatEnd=repeatEndRaw||null;
  var repeatId=repeat!=='none'?'r'+Date.now():null;
  var evs=await famGet('events')||[];
  var baseTs=Date.now();

  function pushRange(fromDs,toDs,extraId){
    // Push one event per day between from and to (inclusive) for multi-day events
    var cur=new Date(fromDs+'T12:00:00');
    var end=new Date(toDs+'T12:00:00');
    var i=0;
    while(cur<=end){
      evs.push({id:baseTs+(extraId||0)+(i++),date:cur.toISOString().split('T')[0],title:name,time:timeStr,who:who,col:col,colHex:colHex,repeat:repeat,repeatId:repeatId,addedBy:session.user.username});
      cur.setDate(cur.getDate()+1);
    }
  }

  if(repeat==='none'){
    pushRange(startDate,endDate,0);
  } else {
    // Build occurrences from startDate until repeatEnd (or sensible default)
    var limitDate;
    if(repeatEnd){
      limitDate=new Date(repeatEnd+'T12:00:00');
    } else {
      limitDate=new Date(startDate+'T12:00:00');
      if(repeat==='daily') limitDate.setDate(limitDate.getDate()+59);
      else if(repeat==='weekly') limitDate.setDate(limitDate.getDate()+51*7);
      else if(repeat==='biweekly') limitDate.setDate(limitDate.getDate()+51*14);
      else limitDate.setMonth(limitDate.getMonth()+11);
    }
    var cur=new Date(startDate+'T12:00:00');
    var step=0;
    while(cur<=limitDate){
      var ds=cur.toISOString().split('T')[0];
      evs.push({id:baseTs+(step++),date:ds,title:name,time:timeStr,who:who,col:col,colHex:colHex,repeat:repeat,repeatId:repeatId,addedBy:session.user.username});
      if(repeat==='daily') cur.setDate(cur.getDate()+1);
      else if(repeat==='weekly') cur.setDate(cur.getDate()+7);
      else if(repeat==='biweekly') cur.setDate(cur.getDate()+14);
      else cur.setMonth(cur.getMonth()+1);
    }
  }
  await famSet('events',evs);
  // Push the first/only event to Google Calendar (for non-repeating or first occurrence)
  if(gcalConnected && evs.length) {
    var newEv = evs[evs.length-1];
    if(!newEv.repeatId) pushEventToGcal(newEv);
    else pushEventToGcal(evs.find(function(e){return e.id===baseTs;})||newEv);
  }
  closeModals(); renderCal(); renderEvents();
}
async function delEvent(id, repeatId) {
  var evs=await famGet('events')||[];
  if(repeatId){
    var choice=confirm('Delete all occurrences of this repeating event?\n\nOK = Delete all  |  Cancel = Delete just this one');
    if(choice){
      // Delete all gcalIds for this repeat series
      evs.filter(function(e){return e.repeatId===repeatId&&e.gcalId;}).forEach(function(e){deleteEventFromGcal(e.gcalId);});
      evs=evs.filter(function(e){return e.repeatId!==repeatId;});
    } else {
      var toDelete=evs.find(function(e){return e.id===id;});
      if(toDelete&&toDelete.gcalId) deleteEventFromGcal(toDelete.gcalId);
      evs=evs.filter(function(e){return e.id!==id;});
    }
  } else {
    var toDelete=evs.find(function(e){return e.id===id;});
    if(toDelete&&toDelete.gcalId) deleteEventFromGcal(toDelete.gcalId);
    evs=evs.filter(function(e){return e.id!==id;});
  }
  await famSet('events',evs);
  renderCal(); renderEvents();
}

function pickColEdit(el){
  document.querySelectorAll('#eed-cpick .copt').forEach(function(o){o.classList.remove('on');});
  el.classList.add('on');
  selColEdit = el.getAttribute('data-c');
}

async function openEventEdit(id) {
  var evs = await famGet('events') || [];
  var ev = evs.find(function(e){ return e.id === id; });
  if(!ev) return;
  // Populate member dropdown
  await populateMemberDropdowns();
  document.getElementById('eed-w').value = ev.who || '';
  document.getElementById('eed-id').value = ev.id;
  document.getElementById('eed-n').value = ev.title || '';
  // Parse time back into fields
  if(ev.time) {
    var tm = ev.time.match(/^(\d+):(\d+)\s*(AM|PM)?$/i);
    if(tm){
      document.getElementById('eed-th').value = tm[1];
      document.getElementById('eed-tm').value = tm[2];
      document.getElementById('eed-tampm').value = tm[3] ? tm[3].toUpperCase() : 'AM';
    }
  } else {
    document.getElementById('eed-th').value = '';
    document.getElementById('eed-tm').value = '';
  }
  // Set color
  selColEdit = ev.col || 'dot-or';
  document.querySelectorAll('#eed-cpick .copt').forEach(function(o){
    o.classList.toggle('on', o.getAttribute('data-c') === selColEdit);
  });
  // Set repeat chip
  var repeatVal = ev.repeat || 'none';
  document.getElementById('eed-repeat').value = repeatVal;
  document.querySelectorAll('#eed-repeat-chips .chip').forEach(function(c){
    c.classList.toggle('on', c.getAttribute('data-v') === repeatVal);
  });
  // Auto-set color if member has one
  var mc = getMemberColor(ev.who);
  if(mc) {
    document.querySelectorAll('#eed-cpick .copt').forEach(function(o){o.classList.remove('on');});
  }
  openModal('evedit');
}

async function saveEventEdit() {
  var id = parseInt(document.getElementById('eed-id').value);
  var name = document.getElementById('eed-n').value.trim();
  if(!name){ alert('Enter an event name'); return; }
  var h = document.getElementById('eed-th').value.trim();
  var m = document.getElementById('eed-tm').value.trim();
  var ampm = document.getElementById('eed-tampm').value;
  var timeStr = h ? h + ':' + (m ? m.padStart(2,'0') : '00') + ' ' + ampm : '';
  var who = document.getElementById('eed-w').value;
  var mc = getMemberColor(who);
  var evs = await famGet('events') || [];
  var ev = evs.find(function(e){ return e.id === id; });
  if(!ev){ closeModals(); return; }
  ev.title = name;
  ev.time = timeStr;
  ev.who = who;
  ev.col = mc ? ev.col : selColEdit;
  ev.colHex = mc || null;
  ev.repeat = document.getElementById('eed-repeat').value;
  await famSet('events', evs);
  closeModals();
  renderCal();
  renderEvents();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TASKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderTasks() {
  var tasks=await famGet('tasks')||[];
  var list=document.getElementById('task-list');
  if(!tasks.length){list.innerHTML='<div class="empty"><span class="empty-ico">üéâ</span>No tasks ‚Äî all clear!</div>';return;}
  function rt(t){
    var pc=t.pri==='h'?'pri-h':t.pri==='m'?'pri-m':'pri-l';
    var pi=t.pri==='h'?'üî¥':t.pri==='m'?'üü°':'üü¢';
    return '<div class="t-item'+(t.done?' dn':'')+'"><div class="tchk'+(t.done?' on':'')+'" onclick="togTask('+t.id+')">'+(t.done?'‚úì':'')+'</div><div class="t-lbl">'+t.title+'</div>'+(t.who?whoPill(t.who):'')+'<div class="pri '+pc+'">'+pi+'</div><button class="xbtn" onclick="delTask('+t.id+')">‚úï</button></div>';
  }
  var a=tasks.filter(function(t){return!t.done;}), d=tasks.filter(function(t){return t.done;});
  list.innerHTML=a.map(rt).join('')+(d.length?'<div class="section-lbl">Completed</div>'+d.map(rt).join(''):'');
}
async function togTask(id){var t=await famGet('tasks')||[];var i=t.find(function(x){return x.id===id;});if(i){i.done=!i.done;await famSet('tasks',t);renderTasks();}}
async function delTask(id){var t=await famGet('tasks')||[];await famSet('tasks',t.filter(function(x){return x.id!==id;}));renderTasks();}
async function addTask(){
  var name=document.getElementById('tk-n').value.trim();
  if(!name){alert('Enter a task');return;}
  var tasks=await famGet('tasks')||[];
  var who=document.getElementById('tk-w').value;
  tasks.unshift({id:Date.now(),title:name,who:who,pri:document.getElementById('tk-p').value,done:false,addedBy:session.user.username});
  await famSet('tasks',tasks);
  closeModals(); renderTasks();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ensureMeals(){
  var m=await famGet('meals')||{};
  var changed=false;
  DAYS.forEach(function(d){if(!m[d]){m[d]={breakfast:'',lunch:'',dinner:'',snack:''};changed=true;}});
  if(changed) await famSet('meals',m);
  return m;
}
async function renderMeals(){
  var meals=await ensureMeals();
  document.getElementById('meal-list').innerHTML=DAYS.map(function(day){
    return '<div class="m-card"><div class="m-hdr"><div class="m-day">'+day+'</div></div>'+
      SLOTS.map(function(s){
        var v=meals[day][s];
        return '<div class="m-slot"><div class="m-slot-lbl">'+SICO[s]+' '+s.charAt(0).toUpperCase()+s.slice(1)+'</div><div class="m-slot-val'+(v?'':' emp')+'" onclick="openMedit(\''+day+'\',\''+s+'\')">'+(v||'+ Add')+'</div></div>';
      }).join('')+'</div>';
  }).join('');
}
function openMedit(day,slot){
  document.getElementById('medit-day').value=day;
  document.getElementById('medit-slot').value=slot;
  document.getElementById('medit-title').textContent=SICO[slot]+' '+slot.charAt(0).toUpperCase()+slot.slice(1)+' ‚Äî '+day;
  famGet('meals').then(function(m){document.getElementById('medit-val').value=(m&&m[day]&&m[day][slot])||'';});
  openModal('medit');
}
async function saveMedit(){
  var m=await ensureMeals();
  m[document.getElementById('medit-day').value][document.getElementById('medit-slot').value]=document.getElementById('medit-val').value.trim();
  await famSet('meals',m);
  closeModals(); renderMeals();
}
async function addMeal(){
  var name=document.getElementById('ml-n').value.trim();
  if(!name){alert('Enter a meal name');return;}
  var m=await ensureMeals();
  m[document.getElementById('ml-d').value][document.getElementById('ml-s').value]=name;
  await famSet('meals',m);
  closeModals(); renderMeals();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderShop(){
  var items=await famGet('shopping')||[];
  var total=items.length, done=items.filter(function(i){return i.done;}).length;
  document.getElementById('shop-lbl').textContent=done+' of '+total+' items checked';
  document.getElementById('shop-bar').style.width=total?(done/total*100)+'%':'0%';
  var list=document.getElementById('shop-list');
  if(!total){list.innerHTML='<div class="empty"><span class="empty-ico">üõí</span>All clear! Add items or use ü§ñ Helper AI.</div>';return;}
  var cats={};
  items.forEach(function(i){if(!cats[i.cat])cats[i.cat]=[];cats[i.cat].push(i);});
  list.innerHTML=Object.keys(cats).map(function(cat){
    return '<div class="s-cat"><div class="s-cat-t">'+cat+'</div>'+
      cats[cat].map(function(it){
        return '<div class="s-item'+(it.done?' dn':'')+'"><div class="schk'+(it.done?' on':'')+'" onclick="togShop('+it.id+')">'+(it.done?'‚úì':'')+'</div><div class="s-lbl">'+it.name+(it.ai?'<span class="ai-badge">ü§ñ AI</span>':'')+'</div><div class="s-qty">'+it.qty+'</div><button class="xbtn" onclick="delShop('+it.id+')">‚úï</button></div>';
      }).join('')+'</div>';
  }).join('');
}
async function togShop(id){var i=await famGet('shopping')||[];var x=i.find(function(x){return x.id===id;});if(x){x.done=!x.done;await famSet('shopping',i);renderShop();}}
async function delShop(id){var i=await famGet('shopping')||[];await famSet('shopping',i.filter(function(x){return x.id!==id;}));renderShop();}
async function checkAllShop(){
  var i=await famGet('shopping')||[];
  i.forEach(function(x){x.done=true;});
  await famSet('shopping',i);renderShop();
}
async function clearDoneShop(){
  var i=await famGet('shopping')||[];
  await famSet('shopping',i.filter(function(x){return !x.done;}));renderShop();
}
async function clearAllShop(){
  if(!confirm('Clear the entire shopping list?')) return;
  await famSet('shopping',[]);renderShop();
}
async function clearMeals(){
  if(!confirm('Clear all meals for this week?')) return;
  var m={};
  DAYS.forEach(function(d){m[d]={breakfast:'',lunch:'',dinner:'',snack:''};});
  await famSet('meals',m);renderMeals();
}
async function addShop(){
  var name=document.getElementById('sh-n').value.trim();
  if(!name){alert('Enter an item');return;}
  var amt=document.getElementById('sh-amt').value.trim()||'1';
  var unit=document.getElementById('sh-unit').value;
  var qty=amt+' '+(unit==='item'?'':unit);
  qty=qty.trim();
  var items=await famGet('shopping')||[];
  items.push({id:Date.now(),name:name,qty:qty,cat:document.getElementById('sh-c').value,done:false,ai:false,addedBy:session.user.username});
  await famSet('shopping',items);
  closeModals(); renderShop();
}

// Convert any old metric quantities in storage to imperial
async function migrateShoppingToImperial(){
  var items=await famGet('shopping')||[];
  var changed=false;
  var metricMap=[
    {re:/^(\d+\.?\d*)\s*kg$/i, fn:function(m){return (parseFloat(m[1])*2.205).toFixed(1)+' lbs';}},
    {re:/^(\d+\.?\d*)\s*g$/i,  fn:function(m){var oz=(parseFloat(m[1])/28.35).toFixed(1);return oz+' oz';}},
    {re:/^(\d+\.?\d*)\s*ml$/i, fn:function(m){var floz=(parseFloat(m[1])/29.57).toFixed(1);return floz+' fl oz';}},
    {re:/^(\d+\.?\d*)\s*l(?:iter)?s?$/i, fn:function(m){var qt=(parseFloat(m[1])*1.057).toFixed(2);return qt+' qt';}},
    {re:/^(\d+)\s*liters?$/i,  fn:function(m){return (parseInt(m[1])===1?'1 quart':parseFloat(m[1]).toFixed(1)+' qt');}},
  ];
  items.forEach(function(it){
    for(var i=0;i<metricMap.length;i++){
      var mm=it.qty&&it.qty.match(metricMap[i].re);
      if(mm){it.qty=metricMap[i].fn(mm);changed=true;break;}
    }
  });
  if(changed) await famSet('shopping',items);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTES / FAMILY BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderNotes(){
  var notes=await famGet('notes')||[];
  var list=document.getElementById('notes-list');
  if(!notes.length){list.innerHTML='<div class="empty"><span class="empty-ico">üìù</span>Nothing posted yet ‚Äî share something with the family!</div>';return;}
  var sorted=notes.slice().sort(function(a,b){return (b.pinned?1:0)-(a.pinned?1:0)||(b.createdAt-a.createdAt);});
  list.innerHTML=sorted.map(function(n){
    var d=new Date(n.createdAt);
    var ds=d.toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    return '<div class="note-card'+(n.pinned?' pinned':'')+'"><div class="note-header"><div class="note-title">'+n.title+(n.pinned?' <span class="pin-badge">üìå Pinned</span>':'')+'</div>'+(n.addedBy===session.user.username||session.user.role==='admin'?'<button class="xbtn" onclick="delNote('+n.id+')">‚úï</button>':'')+'</div><div class="note-body">'+n.body+'</div><div class="note-footer"><span class="note-author">'+n.addedBy+'</span><span>¬∑</span><span>'+ds+'</span></div></div>';
  }).join('');
}
async function addNote(){
  var title=document.getElementById('nt-t').value.trim();
  var body=document.getElementById('nt-b').value.trim();
  if(!title||!body){alert('Please add a title and message');return;}
  var pinChip=document.querySelector('#ov-note .chip[data-v="pin"]');
  var pinned=pinChip&&pinChip.classList.contains('on');
  var notes=await famGet('notes')||[];
  notes.push({id:Date.now(),title:title,body:body,pinned:pinned,author:session.user.displayName,addedBy:session.user.username,createdAt:Date.now()});
  await famSet('notes',notes);
  closeModals(); renderNotes();
}
async function delNote(id){
  var notes=await famGet('notes')||[];
  await famSet('notes',notes.filter(function(n){return n.id!==id;}));
  renderNotes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTOS / MEMORY WALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE DRIVE INTEGRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Drive config stored globally (shared across all families, admin sets it)
async function getDriveConfig(){
  var cfg = await stGet('drive:config') || {};
  return cfg; // {apiKey, folderId}
}
async function testAnthropicKey(){
  var statusEl = document.getElementById('admin-anthropic-status');
  statusEl.innerHTML = '‚è≥ Testing‚Ä¶';
  try {
    var resp = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({model:'claude-haiku-4-5-20251001', max_tokens:10, messages:[{role:'user',content:'hi'}]})
    });
    var data = await resp.json();
    if(data.error){
      statusEl.innerHTML = '‚ùå <span style="color:var(--coral)">Error: ' + (data.error.message||JSON.stringify(data.error)) + '</span>';
    } else if(data.content && data.content.length){
      statusEl.innerHTML = '‚úÖ <span style="color:var(--ocean)">Connected! Helper AI is working.</span>';
    } else {
      statusEl.innerHTML = '‚ö†Ô∏è <span style="color:#B45309">Unexpected: ' + JSON.stringify(data).substring(0,120) + '</span>';
    }
  } catch(err) {
    statusEl.innerHTML = '‚ùå <span style="color:var(--coral)">Network error: ' + err.message + '</span>';
  }
}

async function saveDriveApiKey(){
  var key = document.getElementById('admin-drive-key').value.trim();
  if(!key){alert('Enter an API key');return;}
  var cfg = await getDriveConfig();
  cfg.apiKey = key;
  await stSet('drive:config', cfg);
  alert('‚úÖ API key saved!');
  renderAdmin();
}
async function saveDriveFolderId(){
  var raw = document.getElementById('drive-folder-input').value.trim();
  if(!raw){alert('Paste a folder ID or Drive URL');return;}
  // Extract ID from URL if user pasted full URL
  var match = raw.match(/folders\/([a-zA-Z0-9_-]+)/);
  var folderId = match ? match[1] : raw;
  var cfg = await getDriveConfig();
  cfg.folderId = folderId;
  await stSet('drive:config', cfg);
  document.getElementById('drive-folder-input').value = '';
  await loadDrivePhotos();
}

var drivePhotoCache = []; // [{id, name, caption, src}]

async function loadDrivePhotos(){
  var cfg = await getDriveConfig();
  var statusEl = document.getElementById('drive-status');
  var refreshBtn = document.getElementById('drive-refresh-btn');
  var driveSection = document.getElementById('drive-photos-section');
  var driveGrid = document.getElementById('drive-photo-grid');
  var localLbl = document.getElementById('local-photos-lbl');

  if(!cfg.apiKey || !cfg.folderId){
    statusEl.textContent = 'Not connected ‚Äî paste your folder ID below to link photos';
    driveSection.style.display = 'none';
    localLbl.style.display = 'none';
    drivePhotoCache = [];
    return;
  }

  statusEl.textContent = 'Loading from Google Drive‚Ä¶';
  document.getElementById('drive-folder-input').value = cfg.folderId;

  var url = 'https://www.googleapis.com/drive/v3/files'
    + '?q=%27'+cfg.folderId+'%27+in+parents+and+trashed%3Dfalse+and+mimeType+contains+%27image%2F%27'
    + '&fields=files(id%2Cname%2CcreatedTime)'
    + '&orderBy=createdTime+desc'
    + '&pageSize=100'
    + '&key='+cfg.apiKey;

  try {
    var resp = await fetch(url);
    if(!resp.ok){
      var err = await resp.json().catch(function(){return {};});
      var msg = (err.error && err.error.message) || ('HTTP '+resp.status);
      statusEl.textContent = '‚ö†Ô∏è Drive error: '+msg;
      driveSection.style.display = 'none';
      drivePhotoCache = [];
      return;
    }
    var data = await resp.json();
    var files = data.files || [];
    drivePhotoCache = files.map(function(f){
      return {
        id: 'drive-'+f.id,
        driveId: f.id,
        name: f.name,
        caption: f.name.replace(/\.[^.]+$/,'').replace(/[-_]/g,' '),
        // Use Google's thumbnail endpoint ‚Äî works for public files with just an API key
        src: 'https://lh3.googleusercontent.com/d/'+f.id+'=w1600'
      };
    });

    if(!drivePhotoCache.length){
      statusEl.textContent = 'Connected ‚úÖ ‚Äî folder is empty. Add photos to your Drive folder!';
      driveSection.style.display = 'none';
    } else {
      statusEl.textContent = 'Connected ‚úÖ ‚Äî '+drivePhotoCache.length+' photo'+(drivePhotoCache.length===1?'':'s')+' from Google Drive';
      driveSection.style.display = 'block';
      refreshBtn.style.display = '';
      document.getElementById('drive-count-lbl').textContent = 'üìÅ From Google Drive ('+drivePhotoCache.length+' photos)';
      driveGrid.innerHTML = drivePhotoCache.map(function(p){
        return '<div class="photo-card" onclick="openLightbox(\''+p.id+'\')"><img src="'+p.src+'" alt="'+p.caption+'" loading="lazy"><div class="photo-caption">'+p.caption+'</div></div>';
      }).join('');
    }
  } catch(e) {
    statusEl.textContent = '‚ö†Ô∏è Could not reach Google Drive ‚Äî check your API key and folder sharing.';
    driveSection.style.display = 'none';
    drivePhotoCache = [];
    console.error('Drive fetch error:', e);
  }

  // Label local photos section if there are any
  var localPhotos = await famGet('photos') || [];
  if(localPhotos.length){
    localLbl.textContent = 'üì≤ Uploaded to ReynoldsHub ('+localPhotos.length+' photos)';
    localLbl.style.display = 'block';
  } else {
    localLbl.style.display = 'none';
  }
}

async function driveRefresh(){
  var btn = document.getElementById('drive-refresh-btn');
  btn.textContent = '‚Ä¶';
  await loadDrivePhotos();
  btn.textContent = '‚Üª Refresh';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderPhotos(){
  var photos=await famGet('photos')||[];
  var grid=document.getElementById('photo-grid');
  var localLbl=document.getElementById('local-photos-lbl');
  if(!photos.length){
    grid.innerHTML='';
    // Drive load will set localLbl visibility
  } else {
    grid.innerHTML=photos.map(function(p){
      return '<div class="photo-card" onclick="openLightbox(\''+p.id+'\')"><img src="'+p.data+'" alt="'+(p.caption||'')+'" loading="lazy"><div class="photo-caption">'+(p.caption||'')+'</div><button class="photo-delete" onclick="event.stopPropagation();delPhoto('+p.id+')">‚úï</button></div>';
    }).join('');
  }
  // Load/refresh Drive photos too
  await loadDrivePhotos();
}

function handlePhotoUpload(e) {
  var files = Array.from(e.target.files);
  if(!files.length) return;
  processPhotoFile(files[0], function(dataUrl){
    pendingPhotoData = {data: dataUrl, remaining: files.slice(1)};
    document.getElementById('photo-preview').src = dataUrl;
    document.getElementById('photo-cap').value = '';
    openModal('photo');
  });
  e.target.value = '';
}

function processPhotoFile(file, cb) {
  var reader = new FileReader();
  reader.onload = function(ev){ cb(ev.target.result); };
  reader.readAsDataURL(file);
}

async function savePhoto() {
  if(!pendingPhotoData) return;
  var caption = document.getElementById('photo-cap').value.trim();
  var photos = await famGet('photos') || [];
  photos.unshift({id:Date.now(), data:pendingPhotoData.data, caption:caption, addedBy:session.user.username, createdAt:Date.now()});
  await famSet('photos', photos);
  var remaining = pendingPhotoData.remaining || [];
  pendingPhotoData = null;
  closeModals();
  if(remaining.length) {
    processPhotoFile(remaining[0], function(dataUrl){
      pendingPhotoData = {data:dataUrl, remaining:remaining.slice(1)};
      document.getElementById('photo-preview').src = dataUrl;
      document.getElementById('photo-cap').value = '';
      openModal('photo');
    });
  }
}

async function delPhoto(id) {
  var photos = await famGet('photos') || [];
  await famSet('photos', photos.filter(function(p){return p.id!==id;}));
  renderPhotos();
}

// Unified photo lookup for lightbox/slideshow (local + Drive)
async function getAllPhotos(){
  var local = await famGet('photos') || [];
  // local photos have .data (base64), Drive photos have .src (URL)
  var localMapped = local.map(function(p){ return {id:p.id, src:p.data, caption:p.caption||'', isLocal:true}; });
  var driveMapped = drivePhotoCache.map(function(p){ return {id:p.id, src:p.src, caption:p.caption, isDrive:true}; });
  return driveMapped.concat(localMapped);
}

// Single-photo lightbox (tap from grid)
async function openLightbox(id) {
  var all = await getAllPhotos();
  var idx = all.findIndex(function(x){return String(x.id)===String(id);});
  if(idx<0) return;
  ssPhotos = all;
  ssIdx = idx;
  ssIsPlaying = false;
  ssShowSlideshow(false);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SLIDESHOW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var ssPhotos = [];
var ssIdx = 0;
var ssIsPlaying = false;
var ssTimer = null;
var ssClockTimer = null;
var ssHideTimer = null;
var ssActiveSlot = 'a'; // which img tag is visible
var SS_INTERVAL = 6000; // ms between slides

async function startSlideshow() {
  var all = await getAllPhotos();
  if(!all.length){ alert('Add some photos first ‚Äî upload them or connect a Google Drive folder!'); return; }
  ssPhotos = all;
  ssIdx = 0;
  ssIsPlaying = true;
  ssShowSlideshow(true);
}

function ssShowSlideshow(autoPlay) {
  var ss = document.getElementById('slideshow');
  ss.style.display = 'flex';
  ss.style.flexDirection = 'column';

  // Prevent screen sleep on supported browsers
  if(navigator.wakeLock) {
    navigator.wakeLock.request('screen').catch(function(){});
  }

  ssIsPlaying = autoPlay;
  ssRenderDots();
  ssLoadPhoto(ssIdx, true);
  ssTick();
  ssStartClock();
  ssScheduleHideBars();

  // Keyboard nav
  document.addEventListener('keydown', ssKeyHandler);
}

function stopSlideshow() {
  document.getElementById('slideshow').style.display = 'none';
  clearTimeout(ssTimer);
  clearInterval(ssClockTimer);
  clearTimeout(ssHideTimer);
  document.removeEventListener('keydown', ssKeyHandler);
  ssIsPlaying = false;
}

function ssKeyHandler(e) {
  if(e.key==='ArrowRight'||e.key===' ') ssNext();
  else if(e.key==='ArrowLeft') ssPrev();
  else if(e.key==='Escape') stopSlideshow();
  else if(e.key==='p'||e.key==='P') ssTogglePlay();
}

function ssTogglePlay() {
  ssIsPlaying = !ssIsPlaying;
  document.getElementById('ss-playbtn').textContent = ssIsPlaying ? '‚è∏' : '‚ñ∂';
  if(ssIsPlaying) ssTick();
  else clearTimeout(ssTimer);
}

function ssTick() {
  clearTimeout(ssTimer);
  if(!ssIsPlaying) return;
  ssTimer = setTimeout(function(){
    ssIdx = (ssIdx + 1) % ssPhotos.length;
    ssLoadPhoto(ssIdx, false);
    ssUpdateDots();
    ssTick();
  }, SS_INTERVAL);
}

function ssNext() {
  clearTimeout(ssTimer);
  ssIdx = (ssIdx + 1) % ssPhotos.length;
  ssLoadPhoto(ssIdx, false);
  ssUpdateDots();
  ssRevealBars();
  if(ssIsPlaying) ssTick();
}

function ssPrev() {
  clearTimeout(ssTimer);
  ssIdx = (ssIdx - 1 + ssPhotos.length) % ssPhotos.length;
  ssLoadPhoto(ssIdx, false);
  ssUpdateDots();
  ssRevealBars();
  if(ssIsPlaying) ssTick();
}

function ssLoadPhoto(idx, instant) {
  var p = ssPhotos[idx];
  if(!p) return;
  var imgA = document.getElementById('ss-img-a');
  var imgB = document.getElementById('ss-img-b');

  // Cross-fade: load into hidden slot, then swap
  var current = ssActiveSlot === 'a' ? imgA : imgB;
  var next    = ssActiveSlot === 'a' ? imgB : imgA;

  if(instant) {
    current.src = p.src;
    current.style.opacity = '1';
    next.style.opacity = '0';
  } else {
    next.src = p.src;
    next.style.opacity = '0';
    // Force reflow then fade in
    requestAnimationFrame(function(){
      requestAnimationFrame(function(){
        next.style.opacity = '1';
        current.style.opacity = '0';
        ssActiveSlot = ssActiveSlot === 'a' ? 'b' : 'a';
      });
    });
  }
  document.getElementById('ss-caption').textContent = p.caption || '';
}

function ssRenderDots() {
  var max = Math.min(ssPhotos.length, 30); // don't overflow on large collections
  var dots = '';
  for(var i=0; i<max; i++) {
    dots += '<div id="ss-dot-'+i+'" style="width:'+(i===ssIdx?'20px':'8px')+';height:8px;border-radius:4px;background:'+(i===ssIdx?'#fff':'rgba(255,255,255,.35)')+';transition:all .3s;"></div>';
  }
  if(ssPhotos.length > 30) dots += '<div style="color:rgba(255,255,255,.5);font-size:.7rem;align-self:center">+'+( ssPhotos.length-30)+' more</div>';
  document.getElementById('ss-dots').innerHTML = dots;
}

function ssUpdateDots() {
  var max = Math.min(ssPhotos.length, 30);
  for(var i=0; i<max; i++){
    var d = document.getElementById('ss-dot-'+i);
    if(!d) continue;
    d.style.width = i===ssIdx ? '20px' : '8px';
    d.style.background = i===ssIdx ? '#fff' : 'rgba(255,255,255,.35)';
  }
}

function ssStartClock() {
  function tick(){
    var now = new Date();
    var h = now.getHours(), m = now.getMinutes();
    var ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    document.getElementById('ss-clock').textContent = h + ':' + (m<10?'0':'')+m + ' ' + ampm;
    var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('ss-date').textContent = days[now.getDay()] + ', ' + months[now.getMonth()] + ' ' + now.getDate();
  }
  tick();
  ssClockTimer = setInterval(tick, 15000);
}

function ssRevealBars() {
  var top = document.getElementById('ss-topbar');
  var bot = document.getElementById('ss-botbar');
  top.style.opacity = '1';
  bot.style.opacity = '1';
  ssScheduleHideBars();
}

function ssScheduleHideBars() {
  clearTimeout(ssHideTimer);
  ssHideTimer = setTimeout(function(){
    document.getElementById('ss-topbar').style.opacity = '0';
    document.getElementById('ss-botbar').style.opacity = '0';
  }, 4000);
}

// Tap anywhere on stage reveals bars
document.getElementById && document.addEventListener('DOMContentLoaded', function(){
  var stage = document.getElementById('ss-stage');
  if(stage) stage.addEventListener('click', function(){ ssRevealBars(); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkPendingBadge(){
  var pending = await stGet('pending:signups') || [];
  var badge = document.getElementById('admin-badge');
  if(pending.length){badge.textContent=pending.length;badge.style.display='inline-block';}
  else badge.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE CALENDAR SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var gcalEvents = [];   // cached Google events (merged into calendar view)
var gcalConnected = false;

async function gcalCheckStatus() {
  try {
    var r = await fetch('/api/calendar?action=status');
    var d = await r.json();
    gcalConnected = d.connected;
    updateGcalUI(d);
    if (d.connected) {
      var ind = document.getElementById('gcal-cal-indicator');
      if (ind) ind.style.display = '';
    }
    return d.connected;
  } catch(e) { return false; }
}

function updateGcalUI(status) {
  var badge       = document.getElementById('gcal-status-badge');
  var connInfo    = document.getElementById('gcal-connected-info');
  var connectArea = document.getElementById('gcal-connect-area');
  var calName     = document.getElementById('gcal-cal-name');
  if (!badge) return;
  if (status.connected) {
    badge.textContent = '‚úÖ Connected';
    badge.style.background = 'var(--forest-ll)';
    badge.style.color = 'var(--forest)';
    if (connInfo) connInfo.style.display = '';
    if (connectArea) connectArea.style.display = 'none';
    if (calName) {
      var d = status.connectedAt ? new Date(status.connectedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      calName.innerHTML = 'üìÖ <strong>'+status.calendarName+'</strong><br><span style="font-size:.75rem;color:var(--ink-l)">Connected '+d+'</span>';
    }
  } else {
    badge.textContent = 'Not connected';
    badge.style.background = 'var(--sand-d)';
    badge.style.color = 'var(--ink-l)';
    if (connInfo) connInfo.style.display = 'none';
    if (connectArea) connectArea.style.display = '';
  }
}

function gcalConnect() {
  // Redirect to our server-side OAuth start
  window.location.href = '/api/auth/google';
}

async function gcalDisconnect() {
  if (!confirm('Disconnect Google Calendar? Events from Google will no longer appear in ReynoldsHub.')) return;
  await stDel('gcal:tokens');
  gcalConnected = false;
  gcalEvents = [];
  updateGcalUI({ connected: false });
  var ind = document.getElementById('gcal-cal-indicator');
  if (ind) ind.style.display = 'none';
  renderCal();
  renderEvents();
}

async function gcalSync() {
  var statusEl = document.getElementById('gcal-sync-status');
  if (statusEl) statusEl.textContent = '‚è≥ Syncing‚Ä¶';
  try {
    var r = await fetch('/api/calendar?action=list&days=90');
    var d = await r.json();
    if (d.error || !d.events) throw new Error(d.error || 'No events returned');
    gcalEvents = d.events;
    if (statusEl) statusEl.textContent = '‚úÖ Synced '+gcalEvents.length+' events from "'+d.calendarName+'"';
    renderCal();
    renderEvents();
    setTimeout(function(){ if(statusEl) statusEl.textContent = ''; }, 4000);
  } catch(e) {
    if (statusEl) statusEl.textContent = '‚ö†Ô∏è Sync failed: '+e.message;
  }
}

// Merge local + Google events for rendering
async function getAllEvents() {
  var local = await famGet('events') || [];
  // Filter out any that are actually gcal-sourced (avoid duplicates on re-render)
  var localOnly = local.filter(function(e){ return !e.fromGCal; });
  return localOnly.concat(gcalEvents);
}

// Push a newly-created local event to Google Calendar
async function pushEventToGcal(event) {
  if (!gcalConnected) return;
  try {
    var r = await fetch('/api/calendar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: event })
    });
    var d = await r.json();
    if (d.gcalId) {
      // Store the gcalId on the local event so we can delete it later
      var evs = await famGet('events') || [];
      var ev = evs.find(function(e){ return e.id === event.id; });
      if (ev) {
        ev.gcalId = d.gcalId;
        await famSet('events', evs);
      }
    }
  } catch(e) { console.warn('gcal push failed:', e); }
}

// Delete an event from Google Calendar
async function deleteEventFromGcal(gcalId) {
  if (!gcalConnected || !gcalId) return;
  try {
    await fetch('/api/calendar?action=delete&gcalId='+encodeURIComponent(gcalId), { method: 'DELETE' });
  } catch(e) { console.warn('gcal delete failed:', e); }
}

// Handle OAuth redirect result (?gcal=connected / denied / error)
function handleGcalRedirect() {
  var params = new URLSearchParams(window.location.search);
  var gcal = params.get('gcal');
  if (!gcal) return;
  // Clean the URL
  window.history.replaceState({}, '', window.location.pathname);
  if (gcal === 'connected') {
    gcalSync();          // immediate sync after connect
    gcalCheckStatus();   // update UI
  } else if (gcal === 'denied') {
    alert('Google Calendar connection was cancelled.');
  } else if (gcal === 'error') {
    alert('Google Calendar connection failed. Check that your Vercel environment variables are set correctly.');
  }
}

async function renderAdmin(){
  var pending = await stGet('pending:signups') || [];
  var cfg = await getDriveConfig();
  // Helper AI ‚Äî status shown via Test button, nothing to load here
  renderMembers();
  // Populate Drive settings
  if(document.getElementById('admin-drive-key')){
    document.getElementById('admin-drive-key').value = cfg.apiKey||'';
  }
  // Count all users & families
  var users=[], families=new Set();
  // We'll scan known user keys ‚Äî in a real app you'd have an index
  // Here we store a user index
  var userIndex = await stGet('user-index') || ['sreynolds','jreynolds'];
  for(var i=0;i<userIndex.length;i++){
    var u=await stGet('user:'+userIndex[i]);
    if(u){users.push(u);families.add(u.familyId);}
  }
  document.getElementById('stat-users').textContent=users.length;
  document.getElementById('stat-families').textContent=families.size;
  document.getElementById('stat-pending').textContent=pending.length;

  // Pending requests
  var plist=document.getElementById('pending-list');
  if(!pending.length){plist.innerHTML='<div class="empty"><span class="empty-ico">‚úÖ</span>No pending requests</div>';}
  else{
    plist.innerHTML=pending.map(function(p){
      var d=new Date(p.requestedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      return '<div class="pending-card"><div class="pending-name">'+p.displayName+' <span style="color:var(--ink-l);font-size:.82rem">@'+p.username+'</span></div><div class="pending-meta">Family: '+p.familyName+' &nbsp;¬∑&nbsp; Requested: '+d+(p.reason?'<br>Reason: '+p.reason:'')+'</div><div class="pending-actions"><button class="btn-approve" onclick="approvePending(\''+p.username+'\')">‚úÖ Approve</button><button class="btn-reject" onclick="rejectPending(\''+p.username+'\')">‚úï Reject</button></div></div>';
    }).join('');
  }

  // All users
  var ulist=document.getElementById('all-users-list');
  ulist.innerHTML=users.map(function(u){
    var d=new Date(u.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    return '<div class="user-row"><div class="user-row-av">'+u.displayName[0]+'</div><div class="user-row-info"><div class="user-row-name">'+u.displayName+' <span style="color:var(--ink-l)">@'+u.username+'</span></div><div class="user-row-meta">Family: '+u.familyId+' &nbsp;¬∑&nbsp; Joined: '+d+'</div></div><span class="role-badge '+(u.role==='admin'?'role-admin':'role-member')+'">'+u.role+'</span>'+(u.username!==session.user.username?'<button class="xbtn" onclick="deleteUser(\''+u.username+'\')">‚úï</button>':'')+'</div>';
  }).join('');
}

async function approvePending(username) {
  var pending = await stGet('pending:signups') || [];
  var req = pending.find(function(p){return p.username===username;});
  if(!req) return;
  // Show create user modal pre-filled
  document.getElementById('nu-name').value = req.displayName;
  document.getElementById('nu-user').value = req.username;
  document.getElementById('nu-fam').value = req.familyName.toLowerCase().replace(/\s+/g,'');
  document.getElementById('nu-pass').value = '';
  openModal('newuser');
  // Mark which pending we're approving
  document.getElementById('ov-newuser').dataset.approvingUsername = username;
}

async function rejectPending(username) {
  if(!confirm('Reject request from @'+username+'? This cannot be undone.')) return;
  var pending = await stGet('pending:signups') || [];
  await stSet('pending:signups', pending.filter(function(p){return p.username!==username;}));
  checkPendingBadge();
  renderAdmin();
}

async function createUser() {
  clearAuthMsgs();
  var name=document.getElementById('nu-name').value.trim();
  var username=document.getElementById('nu-user').value.trim().toLowerCase();
  var pass=document.getElementById('nu-pass').value;
  var fam=document.getElementById('nu-fam').value.trim().toLowerCase().replace(/\s+/g,'');
  var role=document.getElementById('nu-role').value;
  if(!name||!username||!pass||!fam){showErr('newuser-err','All fields are required.');return;}
  if(!/^[a-z0-9_]{3,20}$/.test(username)){showErr('newuser-err','Invalid username format.');return;}
  var existing=await stGet('user:'+username);
  if(existing){showErr('newuser-err','Username already exists.');return;}
  var hash=await sha256(pass);
  var newUser={username:username,passwordHash:hash,familyId:fam,role:role,displayName:name,approved:true,createdAt:Date.now()};
  await stSet('user:'+username, newUser);
  // Update user index
  var idx=await stGet('user-index')||['sreynolds','jreynolds'];
  if(!idx.includes(username)) idx.push(username);
  await stSet('user-index', idx);
  // Remove from pending if this was an approval
  var approvingUsername = document.getElementById('ov-newuser').dataset.approvingUsername;
  if(approvingUsername){
    var pending=await stGet('pending:signups')||[];
    await stSet('pending:signups',pending.filter(function(p){return p.username!==approvingUsername;}));
    delete document.getElementById('ov-newuser').dataset.approvingUsername;
  }
  // Ensure family data structure exists
  var famEvents=await stGet('fam:'+fam+':events');
  if(!famEvents) await stSet('fam:'+fam+':events', []);
  var famTasks=await stGet('fam:'+fam+':tasks');
  if(!famTasks) await stSet('fam:'+fam+':tasks', []);
  var famMeals=await stGet('fam:'+fam+':meals');
  if(!famMeals) await stSet('fam:'+fam+':meals', {});
  var famShop=await stGet('fam:'+fam+':shopping');
  if(!famShop) await stSet('fam:'+fam+':shopping', []);
  var famNotes=await stGet('fam:'+fam+':notes');
  if(!famNotes) await stSet('fam:'+fam+':notes', []);
  var famPhotos=await stGet('fam:'+fam+':photos');
  if(!famPhotos) await stSet('fam:'+fam+':photos', []);
  closeModals();
  checkPendingBadge();
  renderAdmin();
}

async function deleteUser(username) {
  if(!confirm('Delete account @'+username+'? This cannot be undone.')) return;
  await stDel('user:'+username);
  var idx=await stGet('user-index')||[];
  await stSet('user-index',idx.filter(function(u){return u!==username;}));
  renderAdmin();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI CHEF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initHelper(){
  chatHist=[];
  document.getElementById('msgs').innerHTML='';
  aiMsg("üëã Hi! I'm **Helper AI** ‚Äî I can help with:\n\nüçΩÔ∏è **Meal plans** ‚Äî full week of dinners, lunches, breakfasts + auto-fill your shopping list\nüí™ **Workout plans** ‚Äî weekly schedules for each family member\nüå¥ **Anything else** ‚Äî routines, tips, ideas\n\nTell me about your family (ages, goals, preferences) or just tap a quick chip below!");
}
function aiMsg(text){
  var msgs=document.getElementById('msgs');
  var d=document.createElement('div');
  d.className='cmsg ai';
  d.innerHTML='<div class="cmav">ü§ñ</div><div class="cbubble">'+text.replace(/\n/g,'<br>').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')+'</div>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function userMsg(text){
  var msgs=document.getElementById('msgs');
  var d=document.createElement('div');
  d.className='cmsg u';
  d.innerHTML='<div class="cbubble">'+text+'</div><div class="cmav" style="background:var(--ocean-l)">üë§</div>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function showTyping(){
  var msgs=document.getElementById('msgs');
  var d=document.createElement('div');
  d.className='cmsg ai';d.id='typing';
  d.innerHTML='<div class="cmav">ü§ñ</div><div class="typing-dots"><span></span><span></span><span></span></div>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){var t=document.getElementById('typing');if(t)t.remove();}
function qp(text){document.getElementById('cinput').value=text;sendMsg();}

async function sendMsg(){
  if(aiTyping)return;
  var input=document.getElementById('cinput');
  var text=input.value.trim();
  if(!text)return;
  input.value='';
  userMsg(text);
  chatHist.push({role:'user',content:text});
  aiTyping=true;document.getElementById('csend').disabled=true;showTyping();
  // Build context: current meals and workouts
  var meals=await famGet('meals')||{};
  var workouts=await famGet('workouts')||[];
  var existingMeals=DAYS.map(function(d){
    var m=meals[d]||{};
    var e=SLOTS.filter(function(s){return m[s];}).map(function(s){return s+': '+m[s];});
    return e.length?d+': '+e.join(', '):null;
  }).filter(Boolean).join('\n');
  var existingWorkouts=workouts.length
    ? workouts.map(function(w){return (w.who||'Everyone')+': '+w.name+' ('+w.type+', '+(w.tag||'unscheduled')+')';}).join('\n')
    : 'None yet';

  var sys = 'You are Helper AI, the Reynolds family assistant. You help with:\n'
    +'‚Ä¢ Meal planning ‚Äî weekly dinners, lunches, breakfasts, shopping lists\n'
    +'‚Ä¢ Workout planning ‚Äî family fitness, adult routines, kids activities\n'
    +'‚Ä¢ General family tips and scheduling\n\n'
    +'Always use US imperial measurements. Never metric.\n\n'
    +'=== HOW TO RESPOND ===\n'
    +'For meal plan requests: give a friendly response AND append a <MEAL_PLAN> block (JSON).\n'
    +'For workout plan requests: give a friendly response AND append a <WORKOUT_PLAN> block (JSON array).\n'
    +'You can do BOTH in one reply if asked.\n\n'
    +'=== MEAL_PLAN FORMAT (append at end when planning meals) ===\n'
    +'<MEAL_PLAN>\n'
    +'{"meals":{"Monday":{"breakfast":"","lunch":"","dinner":"Spaghetti Bolognese","snack":""},'
    +'"Tuesday":{"breakfast":"","lunch":"","dinner":"Chicken Stir Fry","snack":"Apple slices"},'
    +'"Wednesday":{"breakfast":"","lunch":"","dinner":"Grilled Salmon","snack":""},'
    +'"Thursday":{"breakfast":"","lunch":"","dinner":"Homemade Pizza","snack":""},'
    +'"Friday":{"breakfast":"","lunch":"","dinner":"Fish Tacos","snack":""},'
    +'"Saturday":{"breakfast":"Pancakes","lunch":"","dinner":"BBQ Burgers","snack":""},'
    +'"Sunday":{"breakfast":"","lunch":"","dinner":"Roast Chicken","snack":""}},'
    +'"shopping":[{"name":"Chicken breast","qty":"2 lbs","cat":"ü•© Meat & Fish"},{"name":"Milk","qty":"1 gallon","cat":"üßÄ Dairy"}]}\n'
    +'</MEAL_PLAN>\n'
    +'Shopping categories: ü•¶ Produce ü•© Meat & Fish üßÄ Dairy ü•ñ Bakery ü•´ Pantry üßä Frozen üß¥ Household üç≠ Snacks\n\n'
    +'=== WORKOUT_PLAN FORMAT (append at end when planning workouts) ===\n'
    +'<WORKOUT_PLAN>\n'
    +'[{"name":"Morning Run","who":"Shawn","type":"cardio","tag":"Mon/Wed/Fri","dur":"30","notes":"Easy 3 miles"},'
    +'{"name":"Strength Training","who":"Shawn","type":"strength","tag":"Tue/Thu","dur":"45","notes":"Bench, squats, rows 3x10"},'
    +'{"name":"Family Bike Ride","who":"Everyone","type":"cardio","tag":"Saturday","dur":"60","notes":"Trail at park"}]\n'
    +'</WORKOUT_PLAN>\n'
    +'Workout types: strength | cardio | flexibility | sports | custom\n\n'
    +'=== CURRENT FAMILY STATE ===\n'
    +'Meals this week:\n'+(existingMeals||'Nothing planned yet')+'\n\n'
    +'Current workouts:\n'+existingWorkouts;
  // Call our server-side proxy (api/chat.js) ‚Äî key never touches the browser
  fetch('/api/chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,system:sys,messages:chatHist})
  }).then(function(r){return r.json();}).then(function(d){
    hideTyping();aiTyping=false;document.getElementById('csend').disabled=false;
    // Check for API-level error in response body
    if(d.error){
      var errMsg = d.error.message || JSON.stringify(d.error);
      aiMsg("‚ö†Ô∏è API error: " + errMsg);
      console.error('Anthropic API error:', d);
      return;
    }
    var full=(d.content||[]).map(function(b){return b.text||'';}).join('');
    if(!full){
      aiMsg("‚ö†Ô∏è Empty response from API. Raw response: " + JSON.stringify(d).substring(0,200));
      return;
    }
    chatHist.push({role:'assistant',content:full});
    // Strip both plan blocks from display text
    var display=full
      .replace(/<MEAL_PLAN>[\s\S]*?<\/MEAL_PLAN>/,'')
      .replace(/<WORKOUT_PLAN>[\s\S]*?<\/WORKOUT_PLAN>/,'')
      .trim();
    // Handle MEAL_PLAN
    var pm=full.match(/<MEAL_PLAN>([\s\S]*?)<\/MEAL_PLAN>/);
    if(pm){
      try{
        var plan=JSON.parse(pm[1].trim());
        pendingPlan=plan;showAIPlanCard(plan);
        if(!display)display='Your meal plan is ready! üéâ Review it below and tap **Apply** to save it all.';
      }catch(e){console.error('meal plan parse',e);}
    }
    // Handle WORKOUT_PLAN
    var wp=full.match(/<WORKOUT_PLAN>([\s\S]*?)<\/WORKOUT_PLAN>/);
    if(wp){
      try{
        var wplan=JSON.parse(wp[1].trim());
        pendingWorkoutPlan=wplan;showAIWorkoutCard(wplan);
        if(!display)display='Your workout plan is ready! üí™ Review it below and tap **Apply** to save it all.';
      }catch(e){console.error('workout plan parse',e);}
    }
    if(display)aiMsg(display);
  }).catch(function(err){
    hideTyping();aiTyping=false;document.getElementById('csend').disabled=false;
    aiMsg("üòî Network error: " + err.message + "\n\nCheck browser console (F12) for details.");
    console.error('Helper AI fetch error:', err);
  });
}
function showAIPlanCard(plan){
  document.getElementById('ai-plan-card').classList.add('on');
  var prev=document.getElementById('ai-meal-prev');
  prev.innerHTML=DAYS.map(function(day){
    var s=plan.meals[day]||{};
    var meals=SLOTS.filter(function(sl){return s[sl];}).map(function(sl){return '<span style="color:var(--ink-l);font-size:.7rem">'+SICO[sl]+'</span> '+s[sl];}).join(' ¬∑ ');
    return meals?'<div class="ai-mr"><div class="ai-md">'+day.slice(0,3)+'</div><div class="ai-mv">'+meals+'</div></div>':'';
  }).filter(Boolean).join('');
  var items=(plan.shopping||[]).slice(0,14);
  document.getElementById('ai-shop-tags').innerHTML=items.map(function(i){return '<div class="ai-tag">'+i.name+'</div>';}).join('')+((plan.shopping||[]).length>14?'<div class="ai-tag">+'+(plan.shopping.length-14)+' more</div>':'');
}
async function applyPlan(){
  if(!pendingPlan)return;
  var meals=await ensureMeals();
  DAYS.forEach(function(day){
    var dp=pendingPlan.meals[day];
    if(dp)SLOTS.forEach(function(s){if(dp[s])meals[day][s]=dp[s];});
  });
  await famSet('meals',meals);
  var items=await famGet('shopping')||[];
  var existing=new Set(items.map(function(i){return i.name.toLowerCase();}));
  (pendingPlan.shopping||[]).forEach(function(item){
    if(!existing.has(item.name.toLowerCase())){
      items.push({id:Date.now()+Math.random(),name:item.name,qty:item.qty,cat:item.cat,done:false,ai:true,addedBy:'Helper AI'});
      existing.add(item.name.toLowerCase());
    }
  });
  await famSet('shopping',items);
  renderMeals();renderShop();
  document.getElementById('ai-plan-card').classList.remove('on');
  pendingPlan=null;
  aiMsg("‚úÖ Done! Meal plan saved and ingredients added to your **Shopping List** (marked ü§ñ).\n\nTaking you to your shopping list‚Ä¶");
  setTimeout(function(){goSec('shop',document.getElementById('nb-shop'));},2000);
}

function showAIWorkoutCard(wplan){
  var card = document.getElementById('ai-workout-card');
  if(!card) return;
  card.classList.add('on');
  var typeIco={strength:'üèãÔ∏è',cardio:'üèÉ',flexibility:'üßò',sports:'‚öΩ',custom:'‚úèÔ∏è'};
  document.getElementById('ai-workout-prev').innerHTML = wplan.map(function(w){
    return '<div class="ai-mr">'
      +'<div class="ai-md" style="width:80px">'+(typeIco[w.type]||'üí™')+' '+(w.who||'All')+'</div>'
      +'<div class="ai-mv"><strong>'+w.name+'</strong>'
      +(w.tag?' <span style="font-size:.7rem;color:var(--ink-l)">¬∑ '+w.tag+'</span>':'')
      +(w.dur?' <span style="font-size:.7rem;color:var(--ink-l)">¬∑ '+w.dur+' min</span>':'')
      +(w.notes?'<br><span style="font-size:.75rem;color:var(--ink-m)">'+w.notes+'</span>':'')
      +'</div></div>';
  }).join('');
}

async function applyWorkoutPlan(){
  if(!pendingWorkoutPlan) return;
  var workouts = await famGet('workouts') || [];
  var baseTs = Date.now();
  pendingWorkoutPlan.forEach(function(w, i){
    workouts.push({
      id: baseTs + i,
      name: w.name, who: w.who||'Everyone', tag: w.tag||'',
      type: w.type||'custom', dur: w.dur||'30', notes: w.notes||'',
      addedBy: 'Helper AI', createdAt: baseTs
    });
  });
  await famSet('workouts', workouts);
  document.getElementById('ai-workout-card').classList.remove('on');
  pendingWorkoutPlan = null;
  aiMsg("üí™ Done! "+workouts.length+" workouts saved to your **Workouts** tab!\n\nTaking you there now‚Ä¶");
  setTimeout(function(){goSec('workout',document.getElementById('nb-workout'));},1800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){
  var el = document.getElementById('ov-'+id);
  if(!el) return;
  // Clear all text inputs, textareas (but not hidden inputs)
  el.querySelectorAll('input:not([type=hidden]), textarea').forEach(function(inp){
    // Skip inputs managed by code (photo preview, edit event id, etc.)
    if(inp.id==='photo-preview'||inp.type==='file') return;
    inp.value = '';
  });
  // Reset all chip groups to first option
  el.querySelectorAll('.chips').forEach(function(grp){
    var chips = grp.querySelectorAll('.chip');
    chips.forEach(function(c,i){ c.classList.toggle('on', i===0); });
    // sync hidden input
    var hid = grp.nextElementSibling;
    if(hid && hid.type==='hidden' && chips[0]) hid.value = chips[0].getAttribute('data-v')||'';
  });
  // Populate member dropdowns when needed
  if(id==='ev'||id==='task'||id==='evedit') populateMemberDropdowns();
  // Default today's date for budget transactions and events
  if(id==='budget-tx'){
    var bdate = document.getElementById('btx-date');
    if(bdate && !bdate.value) bdate.value = new Date().toISOString().split('T')[0];
  }
  if(id==='ev'){
    var evstart = document.getElementById('ev-start');
    if(evstart && !evstart.value) evstart.value = (selDate||new Date()).toISOString().split('T')[0];
  }
  // Reset color pickers to first swatch
  el.querySelectorAll('.cpick .copt, .member-chip-pick .mcp').forEach(function(o,i,arr){
    // reset all in same parent
  });
  el.querySelectorAll('.cpick').forEach(function(pick){
    pick.querySelectorAll('.copt').forEach(function(o,i){ o.classList.toggle('on', i===0); });
  });
  selCol = 'dot-or';
  el.classList.add('on');
}
function closeModals(){document.querySelectorAll('.ov').forEach(function(o){o.classList.remove('on');});}
document.querySelectorAll('.ov').forEach(function(o){o.addEventListener('click',function(e){if(e.target===o)closeModals();});});

function pickCol(el){document.querySelectorAll('.copt').forEach(function(o){o.classList.remove('on');});el.classList.add('on');selCol=el.getAttribute('data-c');}
function pickChip(el,hid){el.closest('.chips').querySelectorAll('.chip').forEach(function(c){c.classList.remove('on');});el.classList.add('on');document.getElementById(hid).value=el.getAttribute('data-v');}
function toggleChip(el){el.classList.toggle('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTACTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderContacts(){
  var contacts = await famGet('contacts') || [];
  var list = document.getElementById('contacts-list');
  if(!list) return;
  if(!contacts.length){
    list.innerHTML='<div class="empty"><span class="empty-ico">üìû</span>No contacts yet ‚Äî add doctors, school, family numbers!</div>';
    return;
  }
  var groups = {};
  contacts.forEach(function(c){
    var g = c.cat||'üì¶ Other';
    if(!groups[g]) groups[g]=[];
    groups[g].push(c);
  });
  var catOrder = ['üè• Medical','üè´ School','üë®‚Äçüë©‚Äçüëß Family','‚öΩ Sports','üîß Services','üì¶ Other'];
  var allCats = catOrder.filter(function(c){ return groups[c]; })
    .concat(Object.keys(groups).filter(function(c){ return !catOrder.includes(c); }));
  list.innerHTML = allCats.map(function(cat){
    return '<div class="ct-group-hdr">'+cat+'</div>'
      + groups[cat].map(function(c){
        var callBtn = c.phone
          ? '<a class="ct-call" href="tel:'+c.phone.replace(/\D/g,'')+'">üìû Call</a>'
          : '';
        return '<div class="ct-card">'
          +'<div class="ct-av" style="background:var(--ocean-ll)">'+cat.split(' ')[0]+'</div>'
          +'<div class="ct-info">'
          +'<div class="ct-name">'+c.name+'</div>'
          +'<div class="ct-role">'+(c.role||'')+(c.phone?' &nbsp;¬∑&nbsp; '+c.phone:'')+(c.addr?' &nbsp;¬∑&nbsp; '+c.addr:'')+'</div>'
          +'</div>'
          +'<div class="ct-actions">'+callBtn
          +'<button class="xbtn" style="opacity:.5;font-size:.8rem" onclick="editContact('+c.id+')">‚úèÔ∏è</button>'
          +'<button class="xbtn" onclick="delContact('+c.id+')">‚úï</button>'
          +'</div>'
          +'</div>';
      }).join('');
  }).join('');
}

async function saveContact(){
  var name = document.getElementById('ct-name').value.trim();
  if(!name){alert('Enter a name');return;}
  var contacts = await famGet('contacts') || [];
  var existingId = document.getElementById('ct-id').value;
  var entry = {
    id: existingId ? parseInt(existingId) : Date.now(),
    name: name,
    cat: document.getElementById('ct-cat').value,
    phone: document.getElementById('ct-phone').value.trim(),
    role: document.getElementById('ct-role').value.trim(),
    addr: document.getElementById('ct-addr').value.trim(),
    addedBy: session.user.username
  };
  if(existingId){
    var idx = contacts.findIndex(function(c){ return c.id===parseInt(existingId); });
    if(idx>=0) contacts[idx]=entry; else contacts.push(entry);
  } else { contacts.push(entry); }
  await famSet('contacts', contacts);
  closeModals();
  renderContacts();
}

async function editContact(id){
  var contacts = await famGet('contacts') || [];
  var c = contacts.find(function(x){ return x.id===id; });
  if(!c) return;
  document.getElementById('contact-modal-title').textContent = '‚úèÔ∏è Edit Contact';
  document.getElementById('ct-id').value = c.id;
  document.getElementById('ct-name').value = c.name||'';
  document.getElementById('ct-phone').value = c.phone||'';
  document.getElementById('ct-role').value = c.role||'';
  document.getElementById('ct-addr').value = c.addr||'';
  document.getElementById('ct-cat').value = c.cat||'üè• Medical';
  document.querySelectorAll('#ov-contact .chip').forEach(function(chip){
    chip.classList.toggle('on', chip.getAttribute('data-v')===(c.cat||'üè• Medical'));
  });
  document.getElementById('ov-contact').classList.add('on');
}

async function delContact(id){
  var contacts = await famGet('contacts') || [];
  await famSet('contacts', contacts.filter(function(c){ return c.id!==id; }));
  renderContacts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEATHER + CALENDAR HERO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initCalHero(){
  var heroDate = document.getElementById('cal-hero-date');
  var heroSub  = document.getElementById('cal-hero-sub');
  if(!heroDate) return;
  var now = new Date();
  var days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  heroDate.textContent = days[now.getDay()]+', '+months[now.getMonth()]+' '+now.getDate();
  // Greeting by time
  var h = now.getHours();
  var greet = h<12 ? 'Good morning' : h<17 ? 'Good afternoon' : 'Good evening';
  heroSub.textContent = greet+', Reynolds family! üå¥';
  // Fetch weather (Open-Meteo ‚Äî free, no API key)
  fetchWeather();
}

function fetchWeather(){
  // Default: Bloomington MN (55431) ‚Äî lat/lon
  var lat = 44.8408, lon = -93.3771;
  // Try to get user location
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      doWeatherFetch(pos.coords.latitude, pos.coords.longitude);
    }, function(){ doWeatherFetch(lat, lon); }, {timeout:5000});
  } else { doWeatherFetch(lat, lon); }
}

function doWeatherFetch(lat, lon){
  var url = 'https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lon
    +'&current=temperature_2m,weather_code,apparent_temperature&temperature_unit=fahrenheit&wind_speed_unit=mph&forecast_days=1';
  fetch(url).then(function(r){ return r.json(); }).then(function(d){
    var cur = d.current;
    var temp = Math.round(cur.temperature_2m);
    var feels = Math.round(cur.apparent_temperature);
    var code = cur.weather_code;
    var ico = weatherCodeToIcon(code);
    var desc = weatherCodeToDesc(code);
    var tempEl = document.getElementById('cal-weather-temp');
    var descEl = document.getElementById('cal-weather-desc');
    if(tempEl) tempEl.textContent = ico+' '+temp+'¬∞F';
    if(descEl) descEl.textContent = desc+' ¬∑ feels '+feels+'¬∞';
  }).catch(function(){
    // silently fail ‚Äî weather is a nice-to-have
  });
}

function weatherCodeToIcon(c){
  if(c===0) return '‚òÄÔ∏è';
  if(c<=2) return '‚õÖ';
  if(c<=3) return '‚òÅÔ∏è';
  if(c<=48) return 'üå´Ô∏è';
  if(c<=57) return 'üåßÔ∏è';
  if(c<=67) return 'üå®Ô∏è';
  if(c<=77) return '‚ùÑÔ∏è';
  if(c<=82) return 'üå¶Ô∏è';
  if(c<=86) return 'üå®Ô∏è';
  if(c<=99) return '‚õàÔ∏è';
  return 'üå°Ô∏è';
}
function weatherCodeToDesc(c){
  if(c===0) return 'Clear sky';
  if(c<=2) return 'Partly cloudy';
  if(c<=3) return 'Overcast';
  if(c<=48) return 'Fog';
  if(c<=57) return 'Drizzle';
  if(c<=67) return 'Rain';
  if(c<=77) return 'Snow';
  if(c<=82) return 'Rain showers';
  if(c<=86) return 'Snow showers';
  if(c<=99) return 'Thunderstorm';
  return 'Unknown';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var selWorkoutMember = ''; // '' = Everyone / All

async function renderWorkouts() {
  await loadMembers();
  // Build member tabs
  var tabsEl = document.getElementById('workout-member-tabs');
  var allMembers = [{name:'All', color:'#8AA5B5'}].concat(membersCache);
  tabsEl.innerHTML = allMembers.map(function(m){
    var isSel = m.name === (selWorkoutMember||'All');
    var bg = isSel ? m.color : '';
    var border = isSel ? 'border-color:'+m.color : '';
    return '<button class="member-tab'+(isSel?' on':'')+'" '
      +'style="'+(isSel?'background:'+m.color+';color:#fff;border-color:'+m.color:'')
      +'" onclick="selectWorkoutMember(\''+m.name+'\')">'
      +(m.name==='All'?'üë• All':m.name)+'</button>';
  }).join('');
  // Load workouts
  var workouts = await famGet('workouts') || [];
  var filtered = selWorkoutMember && selWorkoutMember!=='All'
    ? workouts.filter(function(w){ return w.who===selWorkoutMember; })
    : workouts;
  var area = document.getElementById('workout-list-area');
  if(!filtered.length){
    area.innerHTML='<div class="empty"><span class="empty-ico">üí™</span>No workouts yet ‚Äî add one or use Helper AI!</div>';
    return;
  }
  // Group by person
  var groups = {};
  filtered.forEach(function(w){
    var key = w.who||'Everyone';
    if(!groups[key]) groups[key]=[];
    groups[key].push(w);
  });
  var typeIco = {strength:'üèãÔ∏è',cardio:'üèÉ',flexibility:'üßò',sports:'‚öΩ',custom:'‚úèÔ∏è'};
  area.innerHTML = Object.keys(groups).map(function(person){
    var mc = getMemberColor(person);
    var header = '<div style="font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:'+(mc||'var(--ink-l)')+';padding:.625rem 0 .25rem;">'+person+'</div>';
    return header + groups[person].map(function(w){
      var typeCls = 'wo-type-'+(w.type||'custom');
      return '<div class="wo-card">'
        +'<div class="wo-icon">'+(typeIco[w.type]||'‚úèÔ∏è')+'</div>'
        +'<div class="wo-info">'
        +'<div class="wo-name">'+w.name+'</div>'
        +'<div class="wo-meta">'
        +(w.tag?'<span class="wo-tag">'+w.tag+'</span>':'')
        +'<span class="wo-type-badge '+typeCls+'">'+(w.type||'custom')+'</span>'
        +(w.dur?'<span style="color:var(--ink-l)">‚è± '+w.dur+' min</span>':'')
        +'</div>'
        +(w.notes?'<div class="wo-notes">'+w.notes+'</div>':'')
        +'</div>'
        +'<button class="xbtn" style="opacity:.5;font-size:.8rem" onclick="editWorkout('+w.id+')">‚úèÔ∏è</button>'
        +'<button class="xbtn" onclick="delWorkout('+w.id+')">‚úï</button>'
        +'</div>';
    }).join('');
  }).join('');
}

function selectWorkoutMember(name){
  selWorkoutMember = name==='All' ? '' : name;
  renderWorkouts();
}

async function openWorkoutModal(id){
  await populateMemberDropdowns();
  // set workout who dropdown
  var woWho = document.getElementById('wo-who');
  if(selWorkoutMember) woWho.value = selWorkoutMember;
  if(id){
    // Edit mode
    var workouts = await famGet('workouts') || [];
    var w = workouts.find(function(x){ return x.id===id; });
    if(!w) return;
    document.getElementById('workout-modal-title').textContent = '‚úèÔ∏è Edit Workout';
    document.getElementById('wo-id').value = w.id;
    document.getElementById('wo-name').value = w.name||'';
    document.getElementById('wo-who').value = w.who||'';
    document.getElementById('wo-tag').value = w.tag||'';
    document.getElementById('wo-notes').value = w.notes||'';
    document.getElementById('wo-type').value = w.type||'strength';
    document.getElementById('wo-dur').value = w.dur||'30';
    document.querySelectorAll('#ov-workout .chips').forEach(function(grp){
      var hid = grp.nextElementSibling;
      if(!hid||hid.type!=='hidden') return;
      var val = document.getElementById(hid.id).value;
      grp.querySelectorAll('.chip').forEach(function(c){ c.classList.toggle('on', c.getAttribute('data-v')===val); });
    });
  } else {
    document.getElementById('workout-modal-title').textContent = 'üí™ Add Workout';
    document.getElementById('wo-id').value = '';
  }
  document.getElementById('ov-workout').classList.add('on');
}

async function editWorkout(id){ openWorkoutModal(id); }

async function saveWorkout(){
  var name = document.getElementById('wo-name').value.trim();
  if(!name){alert('Enter a workout name');return;}
  var workouts = await famGet('workouts') || [];
  var existingId = document.getElementById('wo-id').value;
  var entry = {
    id: existingId ? parseInt(existingId) : Date.now(),
    name: name,
    who: document.getElementById('wo-who').value,
    tag: document.getElementById('wo-tag').value.trim(),
    type: document.getElementById('wo-type').value,
    dur: document.getElementById('wo-dur').value,
    notes: document.getElementById('wo-notes').value.trim(),
    addedBy: session.user.username,
    createdAt: Date.now()
  };
  if(existingId){
    var idx = workouts.findIndex(function(w){ return w.id===parseInt(existingId); });
    if(idx>=0) workouts[idx]=entry; else workouts.push(entry);
  } else {
    workouts.push(entry);
  }
  await famSet('workouts', workouts);
  closeModals();
  renderWorkouts();
}

async function delWorkout(id){
  var workouts = await famGet('workouts') || [];
  await famSet('workouts', workouts.filter(function(w){ return w.id!==id; }));
  renderWorkouts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUDGET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var budgetViewY = new Date().getFullYear();
var budgetViewM = new Date().getMonth();

function budgetMonthNav(dir){
  budgetViewM += dir;
  if(budgetViewM>11){budgetViewM=0;budgetViewY++;}
  else if(budgetViewM<0){budgetViewM=11;budgetViewY--;}
}

async function renderBudget(){
  var MONTHS_SHORT=['January','February','March','April','May','June','July','August','September','October','November','December'];
  var lbl = document.getElementById('budget-month-lbl');
  if(lbl) lbl.textContent = MONTHS_SHORT[budgetViewM]+' '+budgetViewY;

  var txKey = 'budget:'+budgetViewY+':'+pad(budgetViewM+1);
  var txs = await famGet(txKey) || [];
  var income = txs.filter(function(t){ return t.type==='income'; }).reduce(function(s,t){ return s+parseFloat(t.amt||0); },0);
  var expenses = txs.filter(function(t){ return t.type==='expense'; }).reduce(function(s,t){ return s+parseFloat(t.amt||0); },0);
  var net = income - expenses;

  var fmt = function(n){ return '$'+Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,','); };
  var incEl=document.getElementById('budget-income-total');
  var expEl=document.getElementById('budget-expense-total');
  var netEl=document.getElementById('budget-net-total');
  if(incEl) incEl.textContent = fmt(income);
  if(expEl) expEl.textContent = fmt(expenses);
  if(netEl){ netEl.textContent = (net<0?'-':'')+fmt(net); netEl.style.color = net<0?'var(--coral)':'var(--ocean)'; }

  // Budget goal
  var goalData = await famGet('budget:goal') || {};
  var goal = parseFloat(goalData.monthly||0);
  var goalInput = document.getElementById('budget-goal-input');
  if(goalInput && !goalInput.value && goal) goalInput.value = goal;
  var pbar = document.getElementById('budget-pbar');
  var pbarLbl = document.getElementById('budget-pbar-lbl');
  if(pbar && goal>0){
    var pct = Math.min(100, (expenses/goal*100)).toFixed(0);
    pbar.style.width = pct+'%';
    pbar.style.background = expenses>goal?'linear-gradient(90deg,var(--coral),#E8634A)':'linear-gradient(90deg,var(--palm),var(--ocean-l))';
    if(pbarLbl) pbarLbl.textContent = pct+'% of $'+goal.toLocaleString()+' budget used';
  } else if(pbar){ pbar.style.width='0%'; }

  // Category breakdown (expenses only)
  var catEl = document.getElementById('budget-cats');
  if(catEl){
    var cats = {};
    txs.filter(function(t){ return t.type==='expense'; }).forEach(function(t){
      cats[t.cat] = (cats[t.cat]||0) + parseFloat(t.amt||0);
    });
    var sorted = Object.keys(cats).sort(function(a,b){ return cats[b]-cats[a]; });
    var maxVal = sorted.length ? cats[sorted[0]] : 1;
    if(!sorted.length){ catEl.innerHTML='<div class="empty" style="padding:1rem">No expenses this month</div>'; }
    else {
      catEl.innerHTML = sorted.map(function(cat){
        var pct = (cats[cat]/maxVal*100).toFixed(0);
        return '<div class="budget-cat-row">'
          +'<div class="budget-cat-lbl" style="width:110px">'+cat+'</div>'
          +'<div class="budget-cat-bar"><div class="budget-cat-fill" style="width:'+pct+'%"></div></div>'
          +'<div class="budget-cat-amt">'+fmt(cats[cat])+'</div>'
          +'</div>';
      }).join('');
    }
  }

  // Transaction list (newest first)
  var txEl = document.getElementById('budget-tx-list');
  if(txEl){
    var sorted2 = txs.slice().sort(function(a,b){ return b.date>a.date?1:b.date<a.date?-1:0; });
    if(!sorted2.length){ txEl.innerHTML='<div class="empty"><span class="empty-ico">üí≥</span>No transactions yet ‚Äî add income or expenses!</div>'; }
    else {
      txEl.innerHTML = sorted2.map(function(t){
        return '<div class="btx-item">'
          +'<div class="btx-icon">'+(t.type==='income'?'üíµ':'üí∏')+'</div>'
          +'<div class="btx-info"><div class="btx-desc">'+t.desc+'</div><div class="btx-cat">'+t.cat+' ¬∑ '+t.date+'</div></div>'
          +'<div class="btx-amt '+(t.type==='income'?'income':'expense')+'">'+(t.type==='income'?'+':'-')+fmt(parseFloat(t.amt))+'</div>'
          +'<button class="xbtn" onclick="delBudgetTx(\''+t.id+'\')">‚úï</button>'
          +'</div>';
      }).join('');
    }
  }
}

async function saveBudgetGoal(){
  var val = parseFloat(document.getElementById('budget-goal-input').value)||0;
  await famSet('budget:goal', {monthly:val});
}

async function addBudgetTx(){
  var desc = document.getElementById('btx-desc').value.trim();
  var amt = parseFloat(document.getElementById('btx-amt').value);
  var date = document.getElementById('btx-date').value || new Date().toISOString().split('T')[0];
  if(!desc||!amt){alert('Enter a description and amount');return;}
  var txKey = 'budget:'+budgetViewY+':'+pad(budgetViewM+1);
  var txs = await famGet(txKey) || [];
  txs.push({
    id: 'tx'+Date.now(),
    type: document.getElementById('btx-type').value,
    desc: desc, amt: amt, date: date,
    cat: document.getElementById('btx-cat').value,
    addedBy: session.user.username
  });
  await famSet(txKey, txs);
  closeModals();
}

async function delBudgetTx(id){
  var txKey = 'budget:'+budgetViewY+':'+pad(budgetViewM+1);
  var txs = await famGet(txKey) || [];
  await famSet(txKey, txs.filter(function(t){ return t.id!==id; }));
}

window.addEventListener('load', function(){
  // Show warning if Firebase not yet configured
  if(FIREBASE_CONFIG.apiKey.indexOf('PASTE') !== -1) {
    document.getElementById('firebase-warn').style.display = 'block';
    document.getElementById('setup-guide').style.display = 'block';
  } else {
    seedIfNeeded().catch(function(e){console.error('seed error',e);});
  }
});

</script>
</body>
</html>
